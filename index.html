<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Roblox Panel</title>
  <style>
    :root{
      --bg:#f7f7fb; --surface:#ffffff; --surface2:#fbfbfd;
      --text:#111318; --muted:#5c6370;
      --border:#e6e8ee; --border2:#d9dde6; --ring:#111318;
      --btn:#ffffff; --btnText:#111318; --btnBorder:#d9dde6; --btnHover:#f3f4f7;
      --danger:#b00020; --ok:#0b7a3b;
      --radius:16px; --radius2:14px;
      --shadow: 0 10px 30px rgba(17,19,24,.08);
      --focus: 0 0 0 4px rgba(17,19,24,.12);
    }
    [data-theme="dark"]{
      --bg:#0c0f14; --surface:#121722; --surface2:#0f1420;
      --text:#e9edf6; --muted:#a9b2c3;
      --border:#202a3a; --border2:#2a3750; --ring:#e9edf6;
      --btn:#141b29; --btnText:#e9edf6; --btnBorder:#2a3750; --btnHover:#1a2436;
      --danger:#ff4d6d; --ok:#3ddc84;
      --shadow: 0 14px 40px rgba(0,0,0,.45);
      --focus: 0 0 0 4px rgba(233,237,246,.16);
    }
    *{box-sizing:border-box}
    body{
      font-family:system-ui,Arial; margin:0; color:var(--text); background:var(--bg);
      transition: background .25s ease, color .25s ease;
      min-height:100vh; display:flex; justify-content:center; align-items:center; padding:24px;
    }
    .app{width:min(1200px, 100%); margin:0 auto;}
    .top{display:flex; align-items:flex-end; justify-content:space-between; gap:16px; flex-wrap:wrap;}
    h1{margin:0; font-size:34px; letter-spacing:-.5px; display:flex; align-items:center; gap:10px;}
    .pillStatus{
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px;
      border:1px solid var(--border); border-radius:999px;
      background:rgba(255,255,255,.6); backdrop-filter: blur(8px);
    }
    [data-theme="dark"] .pillStatus{background:rgba(18,23,34,.6)}
    .dot{width:8px;height:8px;border-radius:50%; background:var(--muted);}
    .dot.ok{background:var(--ok)}
    .dot.err{background:var(--danger)}
    .dot.load{background:var(--muted); animation:pulse 1.2s ease-in-out infinite}
    @keyframes pulse{0%,100%{opacity:.35}50%{opacity:1}}
    .toolbar{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .seg{
      display:flex; border:1px solid var(--border); border-radius:999px; overflow:hidden;
      background:var(--surface); box-shadow: var(--shadow);
    }
    .seg button{border:0;border-right:1px solid var(--border);border-radius:0;padding:8px 10px;background:transparent;color:var(--muted)}
    .seg button:last-child{border-right:0}
    .seg button[aria-pressed="true"]{background:var(--btnHover);color:var(--text)}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:24px; margin-top:18px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .col{
      border:1px solid var(--border); border-radius:var(--radius); padding:16px;
      background:var(--surface); box-shadow: var(--shadow);
    }
    .colTitle{font-size:22px; margin:0 0 12px; display:flex; align-items:center; justify-content:space-between; gap:12px;}
    .countPill{font-size:12px;opacity:.9;padding:4px 8px;border:1px solid var(--border);border-radius:999px;color:var(--muted);background:var(--surface2)}
    .scroll{height:420px; overflow:auto; border-top:1px solid var(--border); padding-top:12px; padding-right:6px;}
    .card{
      border:1px solid var(--border); border-radius:var(--radius2);
      padding:12px 14px; margin:10px 0; cursor:pointer; user-select:none;
      background:linear-gradient(180deg, var(--surface) 0%, var(--surface2) 100%);
      transition: transform .15s ease, border-color .15s ease, background .2s ease;
      transform: translateZ(0);
    }
    .card:hover{border-color:var(--border2);transform:translateY(-1px)}
    .selected{outline:3px solid var(--ring);outline-offset:0;transform:translateY(-1px) scale(1.01)}
    .row{display:flex; align-items:flex-end; gap:10px; flex-wrap:wrap; margin-top:18px;}
    .field{min-width:220px; flex:1 1 220px;}
    input{
      width:100%; padding:11px 12px; border:1px solid var(--border2); border-radius:12px;
      background:var(--surface); color:var(--text);
      transition:border-color .15s ease, box-shadow .15s ease, background .2s ease;
      outline:none;
    }
    input:focus{box-shadow:var(--focus);border-color:var(--border2)}
    button{
      padding:10px 12px; border:1px solid var(--btnBorder); border-radius:12px;
      background:var(--btn); color:var(--btnText); cursor:pointer;
      transition: transform .12s ease, background .15s ease, border-color .15s ease, opacity .15s ease;
      outline:none; display:inline-flex; align-items:center; gap:8px;
    }
    button:hover{background:var(--btnHover)}
    button:active{transform:translateY(1px)}
    button:disabled{opacity:.45;cursor:not-allowed;transform:none}
    .btns{display:flex;gap:10px;flex-wrap:wrap}
    .divider{height:1px;background:var(--border);margin:14px 0}
    .meta{opacity:.9;margin-top:10px;color:var(--muted);display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .small{font-size:12px;opacity:.88;color:var(--muted)}
    .error{color:var(--danger);opacity:1}
    .label{font-size:12px;opacity:.9;margin-bottom:6px;color:var(--muted)}
    .pill{
      display:inline-block; padding:3px 8px; border:1px solid var(--border);
      border-radius:999px; margin-left:8px; font-size:12px; color:var(--muted); background:var(--surface2);
    }
    .staffPill{border-color:var(--border2);opacity:.95}
    .staffCard{opacity:.55;cursor:not-allowed;filter:grayscale(1)}
    .toastWrap{
      position:fixed; bottom:18px; left:50%; transform:translateX(-50%);
      z-index:9999; pointer-events:none; display:flex; flex-direction:column; gap:8px;
      width:min(560px, calc(100% - 24px));
    }
    .toast{
      pointer-events:auto; border:1px solid var(--border);
      background:rgba(255,255,255,.72); backdrop-filter: blur(10px);
      box-shadow: var(--shadow); border-radius:14px; padding:10px 12px;
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      animation: toastIn .18s ease-out;
    }
    [data-theme="dark"] .toast{background:rgba(18,23,34,.72)}
    @keyframes toastIn{from{transform:translateY(10px);opacity:0}to{transform:translateY(0);opacity:1}}
    .toast .tTitle{font-weight:700}
    .toast .tBody{font-size:12px;color:var(--muted);margin-top:2px}
    .toast .x{border:0;background:transparent;padding:4px 6px;border-radius:10px}
    .toast .x:hover{background:var(--btnHover)}
    .toast.ok{border-color:rgba(11,122,59,.35)}
    .toast.err{border-color:rgba(176,0,32,.35)}
    [data-theme="dark"] .toast.ok{border-color:rgba(61,220,132,.35)}
    [data-theme="dark"] .toast.err{border-color:rgba(255,77,109,.35)}
    .overlay{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center; padding:24px;
      background: radial-gradient(1200px 700px at 50% 20%, rgba(233,237,246,.08), transparent 55%), rgba(0,0,0,.22);
      backdrop-filter: blur(8px); z-index:9998;
    }
    [data-theme="dark"] .overlay{
      background: radial-gradient(1200px 700px at 50% 20%, rgba(233,237,246,.10), transparent 55%), rgba(0,0,0,.55);
    }
    .loginCard{
      width:min(520px, 100%); border:1px solid var(--border); border-radius:18px;
      background:var(--surface); box-shadow: var(--shadow); padding:18px; animation: toastIn .18s ease-out;
    }
    .loginTitle{font-size:22px;margin:0 0 8px}
    .loginHint{margin:0 0 14px;color:var(--muted);font-size:13px}
    .loginRow{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap}
    .loginRow .field{flex:1 1 240px; min-width:240px}
    .loginFoot{margin-top:10px;font-size:12px;color:var(--muted);display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center}
    .ghostBtn{border:1px solid var(--border);background:transparent}
    .ghostBtn:hover{background:var(--btnHover)}
    @media (prefers-reduced-motion: reduce){ *{transition:none !important;animation:none !important} }
  .modOverlay{
  position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:24px;
  background: rgba(0,0,0,.22);
  backdrop-filter: blur(10px);
  z-index:10000;
}
[data-theme="dark"] .modOverlay{ background: rgba(0,0,0,.55); }
.modCard{
  width:min(520px, 100%); border:1px solid var(--border); border-radius:18px;
  background:var(--surface); box-shadow: var(--shadow); padding:18px;
  animation: toastIn .18s ease-out;
}
.modTitle{font-size:20px;margin:0 0 6px}
.modHint{margin:0;color:var(--muted);font-size:13px}
.spinRow{display:flex;align-items:center;gap:12px;margin-top:14px}
.spinner{
  width:34px;height:34px;border-radius:50%;
  border:3px solid rgba(128,128,128,.25);
  border-top-color: var(--ring);
  animation: spin 1s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}
  .logOk{
  border-color: rgba(11,122,59,.35) !important;
  background: linear-gradient(180deg, rgba(11,122,59,.10) 0%, var(--surface2) 100%) !important;
}
.logFail{
  border-color: rgba(176,0,32,.35) !important;
  background: linear-gradient(180deg, rgba(176,0,32,.10) 0%, var(--surface2) 100%) !important;
}
[data-theme="dark"] .logOk{
  border-color: rgba(61,220,132,.35) !important;
  background: linear-gradient(180deg, rgba(61,220,132,.10) 0%, rgba(18,23,34,.6) 100%) !important;
}
[data-theme="dark"] .logFail{
  border-color: rgba(255,77,109,.35) !important;
  background: linear-gradient(180deg, rgba(255,77,109,.10) 0%, rgba(18,23,34,.6) 100%) !important;
}
  </style>
</head>
<body>
  <div class="app" id="app" style="display:none">
    <div class="top">
      <h1>
        Players in-game
        <span class="pillStatus" title="Live status">
          <span class="dot" id="statusDot"></span>
          <span class="small" id="status"></span>
        </span>
      </h1>

      <div class="toolbar">
        <div class="seg" role="group" aria-label="Theme">
          <button id="themeLight" type="button" aria-pressed="false" title="Light">‚òÄÔ∏è</button>
          <button id="themeDark" type="button" aria-pressed="true" title="Dark">üåô</button>
          <button id="themeAuto" type="button" aria-pressed="false" title="Auto">üñ•Ô∏è</button>
        </div>
        <button id="logout" type="button" class="ghostBtn" title="Log out">üö™ Logout</button>
      </div>
    </div>

    <div class="row">
      <div class="field">
        <div class="label">Worker Base URL</div>
        <input id="workerBase" placeholder="https://panel.example.workers.dev" />
      </div>
      <div class="field">
        <div class="label">Admin Key</div>
        <input id="adminKey" placeholder="ADMIN_KEY (stored in your browser)" />
      </div>
      <div class="field">
        <div class="label">Search</div>
        <input id="search" placeholder="Search name / display / id" />
      </div>
      <div class="btns" style="margin-top:18px">
        <button id="save" type="button">üíæ Save</button>
        <button id="refresh" type="button">üîÑ Refresh</button>
      </div>
    </div>

    <div class="meta" id="meta">Updated: ?</div>

    <div class="grid">
      <div class="col">
        <div class="colTitle">
          <span>Active Users</span>
          <span class="countPill" id="activeCount">0</span>
        </div>
        <div class="scroll" id="activeList"></div>
      </div>

      <div class="col">
        <div class="colTitle">
          <span>Enforcement Logs</span>
          <span class="countPill" id="logCount">0</span>
        </div>
        <div class="scroll" id="logList"></div>
      </div>
    </div>

    <div class="divider"></div>

    <div class="btns">
      <button id="kick" type="button">üë¢ Kick</button>
      <button id="kickReason" type="button">üìù Kick With Reason</button>
      <button id="ban" type="button">‚õî Ban</button>
      <button id="banReason" type="button">üßæ Ban With Reason</button>
      <button id="unban" type="button">‚úÖ Unban</button>
      <button id="unbanReason" type="button">üóíÔ∏è Unban With Note</button>
    </div>
  </div>

  <div class="overlay" id="loginOverlay" style="display:none">
    <div class="loginCard">
      <h2 class="loginTitle">Panel Login</h2>
      <p class="loginHint">Enter your panel username to continue.</p>

      <div class="loginRow">
        <div class="field">
          <div class="label">Username</div>
          <input id="loginUser" placeholder="e.g. Username" autocomplete="off" />
        </div>
        <button id="loginBtn" type="button">üîì Login</button>
      </div>

      <div class="loginFoot">
        <span class="small" id="loginStatus"></span>
        <span class="small">Tip: usernames are case-insensitive</span>
      </div>
    </div>
  </div>

<div class="modOverlay" id="modOverlay" style="display:none">
  <div class="modCard">
    <h2 class="modTitle">Moderating User</h2>
    <p class="modHint">This may take some time. Please keep this tab open.</p>
    <div class="spinRow">
      <div class="spinner" aria-hidden="true"></div>
      <div class="small" id="modOverlaySub">Applying action‚Ä¶</div>
    </div>
  </div>
</div>

  <div class="toastWrap" id="toasts"></div>

  <script>
    const ALLOWED_USERNAMES = new Set(["eagla","nebula","specimen","arrow","damage","caprie"]);
    const STAFF_IDS = new Set([8007453710,4976035348,154251360,9930928180,485280430]);


    // ===== Name cache (so Enforcement Logs show names even if older entries lacked them) =====
    const NAME_CACHE_KEY = "panel_name_cache_v1";

    function loadNameCache(){
      try{
        const raw = localStorage.getItem(NAME_CACHE_KEY);
        const obj = raw ? JSON.parse(raw) : {};
        return (obj && typeof obj === "object") ? obj : {};
      } catch { return {}; }
    }

    function saveNameCache(cache){
      try{ localStorage.setItem(NAME_CACHE_KEY, JSON.stringify(cache)); } catch {}
    }

    function cacheNameFrom(user){
      if (!user) return;
      const id = Number(user.userId || 0);
      if (!id) return;
      const username = String(user.username || "");
      const displayName = String(user.displayName || "");
      if (!username && !displayName) return;

      const cache = loadNameCache();
      cache[String(id)] = { username, displayName, at: Date.now() };
      saveNameCache(cache);
    }

    function resolveName(userId, username, displayName){
      const u = String(username || "");
      const d = String(displayName || "");
      if (u || d) return { username: u, displayName: d };

      // Try active list
      const found = activePlayers && activePlayers.find(p => Number(p.userId) === Number(userId));
      if (found && (found.username || found.displayName)){
        cacheNameFrom(found);
        return { username: String(found.username || ""), displayName: String(found.displayName || "") };
      }

      // Try cache
      const cache = loadNameCache();
      const hit = cache[String(Number(userId))];
      if (hit && (hit.username || hit.displayName)){
        return { username: String(hit.username || ""), displayName: String(hit.displayName || "") };
      }

      return { username: "", displayName: "" };
    }
    const els = {
      app: document.getElementById("app"),
      loginOverlay: document.getElementById("loginOverlay"),
      loginUser: document.getElementById("loginUser"),
      loginBtn: document.getElementById("loginBtn"),
      loginStatus: document.getElementById("loginStatus"),
      logout: document.getElementById("logout"),

      status: document.getElementById("status"),
      statusDot: document.getElementById("statusDot"),
      meta: document.getElementById("meta"),

      workerBase: document.getElementById("workerBase"),
      adminKey: document.getElementById("adminKey"),
      search: document.getElementById("search"),
      save: document.getElementById("save"),
      refresh: document.getElementById("refresh"),

      activeList: document.getElementById("activeList"),
      logList: document.getElementById("logList"),
      activeCount: document.getElementById("activeCount"),
      logCount: document.getElementById("logCount"),
      toasts: document.getElementById("toasts"),
      modOverlay: document.getElementById("modOverlay"),
      modOverlaySub: document.getElementById("modOverlaySub"),

      kick: document.getElementById("kick"),
      kickReason: document.getElementById("kickReason"),
      ban: document.getElementById("ban"),
      banReason: document.getElementById("banReason"),
      unban: document.getElementById("unban"),
      unbanReason: document.getElementById("unbanReason"),

      themeLight: document.getElementById("themeLight"),
      themeDark: document.getElementById("themeDark"),
      themeAuto: document.getElementById("themeAuto"),
    };

    function esc(s){
      return String(s ?? "").replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
    }

    function toast(kind, title, body){
      const div = document.createElement("div");
      div.className = "toast " + (kind || "");
      div.innerHTML = `
        <div>
          <div class="tTitle">${esc(title || "")}</div>
          ${body ? `<div class="tBody">${esc(body)}</div>` : ""}
        </div>
        <button class="x" type="button" aria-label="Close">‚úï</button>
      `;
      div.querySelector(".x").onclick = () => div.remove();
      els.toasts.appendChild(div);
      setTimeout(() => { if (div.isConnected) div.remove(); }, 3200);
    }

    function setStatus(state, text){
      els.status.textContent = text || "";
      els.status.className = "small" + (state === "error" ? " error" : "");
      els.statusDot.className = "dot" + (state === "ok" ? " ok" : state === "error" ? " err" : " load");
    }

function showModerationOverlay(show, subText){
  if (!els.modOverlay) return;
  if (show){
    if (els.modOverlaySub) els.modOverlaySub.textContent = subText || "Applying action‚Ä¶";
    els.modOverlay.style.display = "flex";
  } else {
    els.modOverlay.style.display = "none";
  }
}


    function applyTheme(mode){
      localStorage.setItem("panel_theme_mode", mode);
      els.themeLight.setAttribute("aria-pressed", mode === "light");
      els.themeDark.setAttribute("aria-pressed", mode === "dark");
      els.themeAuto.setAttribute("aria-pressed", mode === "auto");
      if (mode === "auto"){ document.documentElement.removeAttribute("data-theme"); return; }
      document.documentElement.setAttribute("data-theme", mode);
    }
    applyTheme(localStorage.getItem("panel_theme_mode") || "dark");
    els.themeLight.onclick = () => applyTheme("light");
    els.themeDark.onclick = () => applyTheme("dark");
    els.themeAuto.onclick = () => applyTheme("auto");

    function normalizeUser(s){ return String(s || "").trim().toLowerCase(); }
    function isLoggedIn(){ return localStorage.getItem("panel_logged_in") === "1"; }
    function setLoggedIn(username){
      localStorage.setItem("panel_logged_in", "1");
      localStorage.setItem("panel_login_user", String(username || ""));
    }
    function clearLoggedIn(){
      localStorage.removeItem("panel_logged_in");
      localStorage.removeItem("panel_login_user");
    }
    function getLoginUser(){ return localStorage.getItem("panel_login_user") || ""; }

    function showLogin(){
      els.app.style.display = "none";
      els.loginOverlay.style.display = "flex";
      els.loginStatus.textContent = "";
      els.loginUser.value = "";
      els.loginUser.focus();
    }
    function showApp(){
      els.loginOverlay.style.display = "none";
      els.app.style.display = "block";
    }

    function attemptLogin(){
      const u = normalizeUser(els.loginUser.value);
      if (!u){ els.loginStatus.textContent = "Enter a username."; els.loginStatus.className = "small error"; return; }
      if (!ALLOWED_USERNAMES.has(u)){
        els.loginStatus.textContent = "Invalid username.";
        els.loginStatus.className = "small error";
        toast("err","Login denied","That username is not allowed");
        return;
      }
      setLoggedIn(u);
      toast("ok","Logged in","Welcome");
      showApp();
      initPanel();
    }

    els.loginBtn.onclick = attemptLogin;
    els.loginUser.addEventListener("keydown", (e) => { if (e.key === "Enter") attemptLogin(); });
    els.logout.onclick = () => { if (!confirm("Log out?")) return; clearLoggedIn(); toast("ok","Logged out",""); showLogin(); };

    function isStaff(userId){ return STAFF_IDS.has(Number(userId)); }

    function baseUrl(){
      const raw = (els.workerBase.value || "").trim().replace(/\/+$/,"");
      return raw;
    }
    function endpoint(path){ return baseUrl() + path; }

    let activePlayers = [];
    let logs = [];
    let selectedActiveUserId = null;
    let selectedLogId = null;
    let uiLocked = false;

    const pendingHidden = new Set();

    let refreshCooldownUntil = 0;
    let refreshCooldownTimer = null;

    function startCooldown(btn, seconds, label){
      const until = Date.now() + seconds * 1000;
      btn.disabled = true;
      const orig = btn.textContent;
      const tick = () => {
        const left = Math.max(0, Math.ceil((until - Date.now()) / 1000));
        if (left > 0){
          btn.textContent = `‚è≥ ${label} (${left}s)`;
          refreshCooldownTimer = setTimeout(tick, 250);
        } else {
          btn.textContent = orig;
          btn.disabled = false;
          if (refreshCooldownTimer) clearTimeout(refreshCooldownTimer);
          refreshCooldownTimer = null;
        }
      };
      tick();
    }

    function beginVerifyLock(){
      uiLocked = true;
      selectedActiveUserId = null;
      selectedLogId = null;
      renderActive();
      renderLogs();
      updateButtons();
      setStatus("loading","Verifying...");
    }
    function endVerifyLock(){
      uiLocked = false;
      updateButtons();
      setStatus("ok","Ready");
    }

    function setCounts(){
      els.activeCount.textContent = String(activePlayers.length || 0);
      els.logCount.textContent = String(logs.length || 0);
    }

    function matchSearch(p){
      const q = normalizeUser(els.search.value);
      if (!q) return true;
      const id = String(p.userId || "");
      const u = normalizeUser(p.username || "");
      const d = normalizeUser(p.displayName || "");
      const by = normalizeUser(p.by || "");
      return id.includes(q) || u.includes(q) || d.includes(q) || by.includes(q);
    }

    function makePlayerCardHTML(p){
      const name = esc(p.displayName || p.username || ("User " + p.userId));
      const handle = esc(p.username || "");
      const team = p.team ? `<span class="pill">${esc(p.team)}</span>` : "";
      const place = p.placeId ? `<span class="pill">Place ${esc(p.placeId)}</span>` : "";
      const staff = isStaff(p.userId) ? `<span class="pill staffPill">STAFF</span>` : "";
      return `
        <div><b>${name}</b> <span class="small">${handle ? "(@" + handle + ")" : ""}</span> ${team} ${place} ${staff}</div>
        <div class="small">UserId: ${Number(p.userId) || ""}</div>
      `;
    }
function makeLogCardHTML(e){
  const resolved = resolveName(e.userId, e.username, e.displayName);
  const name = esc(resolved.displayName || resolved.username || ("User " + e.userId));
  const handle = esc(resolved.username || "");
  const action = esc(String(e.action || "").toUpperCase());
  const by = esc(e.by || "");
  const reason = esc(e.reason || "");
  const when = e.createdAt ? new Date(Number(e.createdAt)).toLocaleString() : "";

  const st = String(e.status || "").toLowerCase();
  const statusText =
    st === "applied" ? "SUCCESS" :
    st === "failed"  ? "NOT SUCCESSFUL" :
    st === "pending" ? "PENDING" :
    (st ? st.toUpperCase() : "");

  const statusPill = statusText ? `<span class="pill">${esc(statusText)}</span>` : "";

  const pills = [
    action ? `<span class="pill">${action}</span>` : "",
    statusPill,
    by ? `<span class="pill">By: ${by}</span>` : "",
    when ? `<span class="pill">${esc(when)}</span>` : ""
  ].filter(Boolean).join(" ");

  return `
    <div><b>${name}</b> <span class="small">${handle ? "(@" + handle + ")" : ""}</span> ${pills}</div>
    <div class="small">UserId: ${Number(e.userId) || ""}</div>
    ${reason ? `<div class="small">Reason: ${reason}</div>` : ""}
  `;
}

    function renderActive(){
      els.activeList.innerHTML = "";
      setCounts();

      const list = activePlayers.filter(matchSearch);
      if (!list.length){
        els.activeList.innerHTML = "<div class='small'>No players match.</div>";
        return;
      }

      for (const p of list){
        if (pendingHidden.has(Number(p.userId))) continue;
        const staff = isStaff(p.userId);
        const div = document.createElement("div");
        div.className =
          "card" +
          (Number(p.userId) === Number(selectedActiveUserId) ? " selected" : "") +
          (staff ? " staffCard" : "");
        div.innerHTML = makePlayerCardHTML(p);
        if (!staff && !uiLocked) div.onclick = () => { selectedActiveUserId = Number(p.userId); selectedLogId = null; renderActive(); renderLogs(); updateButtons(); };
        els.activeList.appendChild(div);
      }
    }
function renderLogs(){
  els.logList.innerHTML = "";
  setCounts();

  const list = logs.filter(matchSearch);
  if (!list.length){
    els.logList.innerHTML = "<div class='small'>No enforcement logs.</div>";
    return;
  }

  for (const e of list){
    const st = String(e.status || "").toLowerCase();
    const extra =
      st === "applied" ? " logOk" :
      st === "failed"  ? " logFail" : "";

    const div = document.createElement("div");
    div.className = "card" + extra + (String(e.id) === String(selectedLogId) ? " selected" : "");
    div.innerHTML = makeLogCardHTML(e);
    if (!uiLocked) div.onclick = () => { selectedLogId = String(e.id); selectedActiveUserId = null; renderActive(); renderLogs(); updateButtons(); };
    els.logList.appendChild(div);
  }
}

      for (const e of list){
        const div = document.createElement("div");
        div.className = "card" + (String(e.id) === String(selectedLogId) ? " selected" : "");
        div.innerHTML = makeLogCardHTML(e);
        if (!uiLocked) div.onclick = () => { selectedLogId = String(e.id); selectedActiveUserId = null; renderActive(); renderLogs(); updateButtons(); };
        els.logList.appendChild(div);
      }
    }

    function updateButtons(){
      if (uiLocked){
        els.kick.disabled = true; els.kickReason.disabled = true; els.ban.disabled = true; els.banReason.disabled = true;
        els.unban.disabled = true; els.unbanReason.disabled = true;
        return;
      }
      const active = activePlayers.find(p => Number(p.userId) === Number(selectedActiveUserId)) || null;
      const logSel = logs.find(e => String(e.id) === String(selectedLogId)) || null;

      const activeOk = !!active && !isStaff(active.userId);
      els.kick.disabled = !activeOk;
      els.kickReason.disabled = !activeOk;
      els.ban.disabled = !activeOk;
      els.banReason.disabled = !activeOk;

      const canUnban = !!logSel && String(logSel.action || "").toLowerCase() === "ban" && !isStaff(logSel.userId);
      els.unban.disabled = !canUnban;
      els.unbanReason.disabled = !canUnban;
    }

    async function fetchPlayers(){
      const url = endpoint("/players");
      setStatus("loading","Loading players...");
      const res = await fetch(url, { cache:"no-store" });
      if (!res.ok) throw new Error("Players HTTP " + res.status);
      const data = await res.json();
      activePlayers = Array.isArray(data.players) ? data.players : [];
      try{ for (const p of activePlayers) cacheNameFrom(p); } catch {}
      els.meta.textContent = `Updated: ${data.updatedAt || "?"} | Total Players: ${data.totalPlayers ?? activePlayers.length}`;
      renderActive();
      updateButtons();
      setStatus("ok","OK");
      return activePlayers;
    }

    async function fetchLogs(){
      const url = endpoint("/history");
      const res = await fetch(url, { cache:"no-store" });
      if (!res.ok) throw new Error("Logs HTTP " + res.status);
      const data = await res.json();
      logs = Array.isArray(data.items) ? data.items : [];
      renderLogs();
      updateButtons();
      return logs;
    }

    async function fetchPlayersOnce(){
      const url = endpoint("/players");
      const res = await fetch(url, { cache:"no-store" });
      if (!res.ok) throw new Error("Players HTTP " + res.status);
      const data = await res.json();
      return Array.isArray(data.players) ? data.players : [];
    }

    async function verifyByPresence(userId, timeoutMs){
      const start = Date.now();
      while (Date.now() - start < timeoutMs){
        try{
          const players = await fetchPlayersOnce();
          const stillHere = players.some(p => Number(p.userId) === Number(userId));
          if (!stillHere) return { ok:true };
        } catch {}
        await new Promise(r => setTimeout(r, 1000));
      }
      return { ok:false, timeout:true };
    }

    async function tryHistory(id){
      try{
        const res = await fetch(endpoint("/history"), { cache:"no-store" });
        if (!res.ok) return null;
        const data = await res.json();
        const items = Array.isArray(data.items) ? data.items : [];
        return items.find(x => String(x && x.id) === String(id)) || null;
      } catch { return null; }
    }

    async function waitHistoryOk(id, timeoutMs){
      const start = Date.now();
      while (Date.now() - start < timeoutMs){
        const item = await tryHistory(id);
        if (item && item.status === "applied") return { ok:true };
        if (item && item.status === "failed") return { ok:false, message: "failed" };
        await new Promise(r => setTimeout(r, 1000));
      }
      return { ok:false, timeout:true };
    }

    async function sendModeration(action, user, reason){
  if (!user) return { ok:false };
  const userId = Number(user.userId || 0);

  if (isStaff(userId)) {
    toast("err", "Blocked", "That user is STAFF and cannot be moderated.");
    return { ok:false };
  }

  const adminKey = els.adminKey.value.trim();
  if (!adminKey) {
    toast("err", "Missing ADMIN_KEY", "Enter ADMIN_KEY first.");
    return { ok:false };
  }

  // cache for nicer logs
  try{ cacheNameFrom(user); } catch {}

  const payload = {
    action,
    userId,
    reason: String(reason || ""),
    by: String(getLoginUser() || ""),
    username: String(user.username || ""),
    displayName: String(user.displayName || "")
  };

  let res, body = null;
  try{
    res = await fetch(endpoint("/admin/moderate"), {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "x-admin-key": adminKey
      },
      body: JSON.stringify(payload)
    });
    try { body = await res.json(); } catch { body = null; }
  } catch(e){
    toast("err", "Request failed", e.message);
    return { ok:false };
  }

  if (!res || !res.ok) {
    toast("err", "Request rejected", (body && body.error) ? body.error : ("HTTP " + (res ? res.status : "?")));
    return { ok:false };
  }

  return { ok:true, id: body && body.id ? String(body.id) : "" };
}


async function enforceAndVerify(action, user, reason){
  const act = String(action || "").toLowerCase();
  const userId = Number(user && user.userId || 0);

  if (act === "unban"){
    const sent = await sendModeration("unban", user, reason || "");
    return (sent && sent.ok) ? { ok:true, id: sent.id || "" } : { ok:false, message: "unban failed" };
  }

  if (!userId) return { ok:false, message: "missing userId" };

  const started = Date.now();
  const hardTimeoutMs = 120000;
  const resendEveryMs = 2500;
  const checkEveryMs  = 900;
  const refreshUiEveryMs = 1200;

  let lastSendAt = 0;
  let lastUiAt = 0;
  let lastId = "";

  async function refreshUi(){
    try{
      await fetchPlayers();
      await fetchLogs();
    } catch {}
  }

  async function isStillHere(){
    try{
      const players = await fetchPlayersOnce();
      return players.some(p => Number(p.userId) === userId);
    } catch {
      return true;
    }
  }

  pendingHidden.add(userId);
  renderActive();
  updateButtons();

  if (!(await isStillHere())){
    pendingHidden.delete(userId);
    renderActive();
    updateButtons();
    return { ok:true, id: "" };
  }

  while (Date.now() - started < hardTimeoutMs){
    const now = Date.now();

    if (now - lastSendAt >= resendEveryMs){
      const sent = await sendModeration(act, user, reason || "");
      lastSendAt = now;
      if (sent && sent.ok && sent.id) lastId = String(sent.id);
    }

    if (now - lastUiAt >= refreshUiEveryMs){
      lastUiAt = now;
      await refreshUi();
    }

    await new Promise(r => setTimeout(r, checkEveryMs));
    const still = await isStillHere();
    if (!still){
      pendingHidden.delete(userId);
      renderActive();
      updateButtons();
      return { ok:true, id: lastId };
    }
  }

  pendingHidden.delete(userId);
  renderActive();
  updateButtons();
  return { ok:false, timeout:true, message: "Timed out (kept retrying)." };
}

  // Safety: if no userId, fail fast
  if (!userId) return { ok:false, message: "missing userId" };

  const started = Date.now();
  const hardTimeoutMs = 90000; // 90s overall
  const resendEveryMs = 3000;  // resend every 3s if still present
  const checkEveryMs  = 1200;  // check presence every 1.2s

  let lastSendAt = 0;
  let lastId = "";

  // helper: check if user still in game
  async function isStillHere(){
    try{
      const players = await fetchPlayersOnce();
      return players.some(p => Number(p.userId) === userId);
    } catch {
      return true; // if we can't read, assume still present and keep trying
    }
  }

  // If the player is already gone, succeed immediately (covers multi-server / already kicked)
  if (!(await isStillHere())){
    return { ok:true, id: "" };
  }

  while (Date.now() - started < hardTimeoutMs){
    const now = Date.now();

    // re-send action if needed
    if (now - lastSendAt >= resendEveryMs){
      const sent = await sendModeration(act, user, reason || "");
      lastSendAt = now;
      if (sent && sent.ok && sent.id) lastId = String(sent.id);

      // also mark history "applied" quickly if worker supports it, but don't wait on it
      // (we verify by presence instead)
    }

    // presence check
    await new Promise(r => setTimeout(r, checkEveryMs));
    const still = await isStillHere();
    if (!still){
      return { ok:true, id: lastId };
    }
  }

  return { ok:false, timeout:true, message: "Timed out waiting for player to leave (kept retrying)." };
}

    function getSelectedActive(){ return activePlayers.find(p => Number(p.userId) === Number(selectedActiveUserId)) || null; }
    function getSelectedLog(){ return logs.find(e => String(e.id) === String(selectedLogId)) || null; }

    async function refreshAll(){
      await fetchPlayers();
      await fetchLogs();
    }

    els.search.addEventListener("input", () => { renderActive(); renderLogs(); updateButtons(); });

    els.save.onclick = () => {
      localStorage.setItem("worker_base_v1", baseUrl());
      localStorage.setItem("admin_key_v1", els.adminKey.value.trim());
      toast("ok","Saved","Worker Base + Admin Key stored in this browser");
      setStatus("ok","Saved");
    };

    els.refresh.onclick = async () => {
      if (els.refresh.disabled) return;
      startCooldown(els.refresh, 10, "Refresh");
      try{
        await refreshAll();
      } catch(e){
        setStatus("error", "Refresh failed: " + e.message);
        toast("err","Refresh failed", e.message);
      }
    };

    async function runAction(action, user, reason, onSuccess){
  const act = String(action || "").toLowerCase();
  if (act === "kick" || act === "ban"){
    showModerationOverlay(true, "Moderating user‚Ä¶ this may take some time.");
  }

  beginVerifyLock();
  try{
    const v = await enforceAndVerify(action, user, reason || "");
    if (v.ok){
      toast("ok","Enforcement action approved","");
      if (typeof onSuccess === "function") onSuccess();
      await fetchLogs();
      await fetchPlayers();
    } else {
      toast("err", v.timeout ? "ERROR: TIME OUT" : "Failed", v.message || "");
    }
  } finally {
    endVerifyLock();
    showModerationOverlay(false, "");
  }
}
      } finally {
        endVerifyLock();
      }
    }

    els.kick.onclick = async () => {
      const p = getSelectedActive(); if (!p) return;
      await runAction("kick", p, "", null);
    };

    els.kickReason.onclick = async () => {
      const p = getSelectedActive(); if (!p) return;
      const r = prompt("Kick reason?") || "";
      await runAction("kick", p, r, null);
    };

    els.ban.onclick = async () => {
      const p = getSelectedActive(); if (!p) return;
      await runAction("ban", p, "", null);
    };

    els.banReason.onclick = async () => {
      const p = getSelectedActive(); if (!p) return;
      const r = prompt("Ban reason?") || "";
      await runAction("ban", p, r, null);
    };

    els.unban.onclick = async () => {
      const e = getSelectedLog(); if (!e) return;
      const user = { userId: e.userId, username: e.username || "", displayName: e.displayName || "" };
      await runAction("unban", user, "", () => { selectedLogId = null; });
    };

    els.unbanReason.onclick = async () => {
      const e = getSelectedLog(); if (!e) return;
      const r = prompt("Unban note?") || "";
      const user = { userId: e.userId, username: e.username || "", displayName: e.displayName || "" };
      await runAction("unban", user, r, () => { selectedLogId = null; });
    };

    function initPanel(){
      const savedBase = localStorage.getItem("worker_base_v1") || "https://panel.sixteysevenharry.workers.dev";
      const savedAdmin = localStorage.getItem("admin_key_v1") || "";
      els.workerBase.value = savedBase;
      els.adminKey.value = savedAdmin;
      setStatus("ok","Ready (press Refresh)");
      renderActive();
      renderLogs();
      updateButtons();
    }

    if (isLoggedIn()){ showApp(); initPanel(); }
    else { showLogin(); }
  </script>
</body>
</html>
