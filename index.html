<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="dark light" />
  <title>Roblox Panel</title>
  <style>
    :root{
      --bg0:#070A12;
      --bg1:#0B1020;
      --surface:#0f172a;
      --surface2:#0b1224;
      --surface3:#0a1020;
      --card:#0f162d;
      --text:#e7eefc;
      --muted:#9aa8c7;
      --muted2:#6f7ea6;
      --border:rgba(255,255,255,.10);
      --border2:rgba(255,255,255,.16);
      --shadow: 0 18px 55px rgba(0,0,0,.48);
      --shadow2: 0 10px 30px rgba(0,0,0,.38);
      --ring: 0 0 0 4px rgba(170,196,255,.18);
      --accent:#7c6cff;
      --accent2:#4fd1c5;
      --ok:#22c55e;
      --warn:#fbbf24;
      --danger:#fb7185;

      --radius:18px;
      --radius2:14px;
      --radius3:12px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    [data-theme="light"]{
      --bg0:#f6f7ff;
      --bg1:#eef2ff;
      --surface:#ffffff;
      --surface2:#f8fafc;
      --surface3:#f1f5f9;
      --card:#ffffff;
      --text:#0b1224;
      --muted:#51607a;
      --muted2:#6b7a95;
      --border:rgba(17,24,39,.10);
      --border2:rgba(17,24,39,.16);
      --shadow: 0 18px 55px rgba(17,24,39,.10);
      --shadow2: 0 10px 30px rgba(17,24,39,.10);
      --ring: 0 0 0 4px rgba(124,108,255,.18);
      --accent:#5b4bff;
      --accent2:#0ea5e9;
      --ok:#16a34a;
      --warn:#d97706;
      --danger:#e11d48;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(124,108,255,.18), transparent 55%),
        radial-gradient(900px 600px at 80% 20%, rgba(79,209,197,.14), transparent 55%),
        radial-gradient(1200px 900px at 50% 100%, rgba(251,113,133,.08), transparent 65%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
      display:flex;
      align-items:stretch;
      justify-content:center;
      padding: 18px;
    }

    a{ color:inherit; }
    .wrap{
      width:min(1320px, 100%);
      display:flex;
      gap: 16px;
      align-items:stretch;
    }

    .shell{
      flex:1;
      border: 1px solid var(--border);
      border-radius: calc(var(--radius) + 4px);
      background: rgba(15, 23, 42, .55);
      background: color-mix(in oklab, var(--surface) 72%, transparent);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
      backdrop-filter: blur(12px);
    }
    [data-theme="light"] .shell{
      background: color-mix(in oklab, var(--surface) 82%, transparent);
      backdrop-filter: blur(10px);
    }

    .topbar{
      padding: 14px 14px 12px 14px;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 12px;
      min-width: 220px;
    }
    .logo{
      width: 40px;
      height: 40px;
      border-radius: 14px;
      background:
        radial-gradient(18px 18px at 30% 30%, rgba(255,255,255,.25), transparent 60%),
        linear-gradient(135deg, rgba(124,108,255,.95), rgba(79,209,197,.90));
      box-shadow: 0 10px 25px rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.18);
      display:flex;
      align-items:center;
      justify-content:center;
      flex:0 0 auto;
    }
    .logo svg{ width: 22px; height: 22px; opacity:.96; }
    .brand h1{
      margin:0;
      font-size: 18px;
      letter-spacing: -.2px;
      line-height:1.2;
    }
    .brand .sub{
      margin-top: 2px;
      font-size: 12px;
      color: var(--muted);
    }

    .statusPill{
      display:inline-flex;
      align-items:center;
      gap: 10px;
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: color-mix(in oklab, var(--surface2) 60%, transparent);
      box-shadow: var(--shadow2);
      backdrop-filter: blur(10px);
      flex-wrap:wrap;
    }
    .dot{
      width: 10px; height: 10px;
      border-radius: 999px;
      background: var(--muted2);
      box-shadow: 0 0 0 5px rgba(255,255,255,.03);
    }
    .dot.ok{ background: var(--ok); }
    .dot.err{ background: var(--danger); }
    .dot.load{
      background: var(--warn);
      animation: pulse 1.2s ease-in-out infinite;
    }
    @keyframes pulse{ 0%,100%{opacity:.35} 50%{opacity:1} }

    .topActions{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }

    .seg{
      display:flex;
      border: 1px solid var(--border);
      border-radius: 999px;
      overflow:hidden;
      background: color-mix(in oklab, var(--surface2) 75%, transparent);
      box-shadow: var(--shadow2);
    }
    .seg button{
      border:0;
      padding: 8px 10px;
      background: transparent;
      color: var(--muted);
      cursor:pointer;
      transition: background .15s ease, color .15s ease;
    }
    .seg button + button{ border-left:1px solid var(--border); }
    .seg button[aria-pressed="true"]{
      background: color-mix(in oklab, var(--accent) 20%, transparent);
      color: var(--text);
    }

    button, input{
      font-family: inherit;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: color-mix(in oklab, var(--surface2) 70%, transparent);
      color: var(--text);
      cursor:pointer;
      transition: transform .12s ease, background .15s ease, border-color .15s ease, opacity .15s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{ background: color-mix(in oklab, var(--surface2) 86%, transparent); border-color: var(--border2); }
    .btn:active{ transform: translateY(1px); }
    .btn:focus{ outline:none; box-shadow: var(--ring); }
    .btn:disabled{ opacity:.45; cursor:not-allowed; transform:none; }

    .btn.primary{
      border-color: color-mix(in oklab, var(--accent) 55%, var(--border));
      background: linear-gradient(135deg, color-mix(in oklab, var(--accent) 52%, transparent), color-mix(in oklab, var(--accent2) 30%, transparent));
    }
    .btn.primary:hover{ filter: brightness(1.03); }
    .btn.danger{
      border-color: color-mix(in oklab, var(--danger) 40%, var(--border));
      background: color-mix(in oklab, var(--danger) 20%, transparent);
    }
    .btn.ghost{
      background: transparent;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: color-mix(in oklab, var(--surface2) 66%, transparent);
      color: var(--muted);
      font-size: 12px;
    }
    .pill strong{ color: var(--text); font-weight: 700; }
    .who{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: color-mix(in oklab, var(--surface2) 65%, transparent);
      box-shadow: var(--shadow2);
    }
    .who .k{ color: var(--muted); font-size:12px; }
    .who .v{ font-weight:700; font-size:12px; max-width:160px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    .content{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap: 16px;
      padding: 14px;
    }
    @media (max-width: 1020px){
      .content{ grid-template-columns: 1fr; }
    }

    .panel{
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: color-mix(in oklab, var(--surface) 78%, transparent);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .panelHead{
      padding: 12px 12px 10px 12px;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
    }
    .panelHead h2{
      margin:0;
      font-size: 14px;
      letter-spacing: .2px;
      text-transform: uppercase;
      color: var(--muted);
    }
    .panelHead .hint{
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
      max-width: 52ch;
    }

    .panelBody{
      padding: 12px;
    }

    .field{
      display:flex;
      flex-direction:column;
      gap: 6px;
      margin-bottom: 10px;
    }
    .label{
      font-size: 12px;
      color: var(--muted);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .label .mono{ font-family: var(--mono); font-size: 11px; color: var(--muted2); }
    input{
      width: 100%;
      padding: 11px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: color-mix(in oklab, var(--surface2) 80%, transparent);
      color: var(--text);
      outline:none;
      transition: border-color .15s ease, box-shadow .15s ease, background .15s ease;
    }
    input:focus{
      border-color: color-mix(in oklab, var(--accent) 45%, var(--border));
      box-shadow: var(--ring);
      background: color-mix(in oklab, var(--surface2) 92%, transparent);
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 520px){
      .grid2{ grid-template-columns: 1fr; }
    }

    .meta{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      margin-top: 10px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.2;
    }

    .main{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      align-items:stretch;
    }
    @media (max-width: 980px){
      .main{ grid-template-columns: 1fr; }
    }

    .listHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 12px 12px 10px 12px;
      border-bottom: 1px solid var(--border);
      background: color-mix(in oklab, var(--surface2) 55%, transparent);
    }
    .listHead .left{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
    }
    .listHead h3{
      margin:0;
      font-size: 14px;
      letter-spacing: .2px;
      text-transform: uppercase;
      color: var(--muted);
    }
    .count{
      font-size: 12px;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
      background: color-mix(in oklab, var(--surface2) 70%, transparent);
    }

    .scroll{
      height: 520px;
      overflow:auto;
      padding: 10px;
    }
    @media (max-width: 980px){
      .scroll{ height: 420px; }
    }

    .card{
      border: 1px solid var(--border);
      border-radius: var(--radius2);
      background: linear-gradient(180deg, color-mix(in oklab, var(--card) 80%, transparent), color-mix(in oklab, var(--surface2) 60%, transparent));
      padding: 12px 12px;
      margin: 10px 0;
      box-shadow: 0 8px 24px rgba(0,0,0,.22);
      transition: transform .15s ease, border-color .15s ease, background .15s ease, box-shadow .15s ease;
      cursor:pointer;
      user-select:none;
    }
    .card:hover{
      border-color: var(--border2);
      transform: translateY(-1px);
      box-shadow: 0 10px 26px rgba(0,0,0,.28);
    }
    .card.selected{
      outline: 3px solid color-mix(in oklab, var(--accent) 55%, transparent);
      outline-offset: 0;
      transform: translateY(-1px);
      border-color: color-mix(in oklab, var(--accent) 38%, var(--border2));
    }

    .chipRow{
      display:flex;
      gap: 8px;
      flex-wrap:wrap;
      margin-top: 8px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      font-size: 11px;
      padding: 5px 9px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: color-mix(in oklab, var(--surface2) 68%, transparent);
      color: var(--muted);
    }
    .chip.ok{ border-color: color-mix(in oklab, var(--ok) 30%, var(--border)); background: color-mix(in oklab, var(--ok) 15%, transparent); }
    .chip.fail{ border-color: color-mix(in oklab, var(--danger) 28%, var(--border)); background: color-mix(in oklab, var(--danger) 14%, transparent); }
    .chip.warn{ border-color: color-mix(in oklab, var(--warn) 30%, var(--border)); background: color-mix(in oklab, var(--warn) 16%, transparent); }
    .chip.accent{ border-color: color-mix(in oklab, var(--accent) 30%, var(--border)); background: color-mix(in oklab, var(--accent) 16%, transparent); color: color-mix(in oklab, var(--text) 92%, var(--muted)); }

    .staffCard{
      opacity: .55;
      cursor: not-allowed;
      filter: grayscale(.9);
    }

    .logSus{ border-color: color-mix(in oklab, var(--warn) 44%, var(--border2)) !important; }
    .logOk{ border-color: color-mix(in oklab, var(--ok) 42%, var(--border2)) !important; }
    .logFail{ border-color: color-mix(in oklab, var(--danger) 42%, var(--border2)) !important; }

    .empty{
      padding: 18px 14px;
      color: var(--muted);
      font-size: 13px;
      text-align:center;
      border: 1px dashed var(--border);
      border-radius: var(--radius2);
      margin: 10px 0;
      background: color-mix(in oklab, var(--surface2) 64%, transparent);
    }

    .actionDock{
      position: sticky;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 12px;
      background: linear-gradient(180deg, transparent, color-mix(in oklab, var(--surface3) 88%, transparent) 22%, color-mix(in oklab, var(--surface3) 92%, transparent));
      border-top: 1px solid var(--border);
      backdrop-filter: blur(14px);
      z-index: 10;
    }
    .dockRow{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .dockRow .left{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .dockRow .right{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .dockHint{
      color: var(--muted);
      font-size: 12px;
      max-width: 70ch;
    }

    .toastWrap{
      position: fixed;
      right: 18px;
      bottom: 18px;
      z-index: 9999;
      width: min(420px, calc(100% - 36px));
      display:flex;
      flex-direction:column;
      gap: 10px;
      pointer-events:none;
    }
    .toast{
      pointer-events:auto;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: color-mix(in oklab, var(--surface2) 72%, transparent);
      box-shadow: var(--shadow2);
      backdrop-filter: blur(14px);
      padding: 10px 12px;
      display:flex;
      gap: 10px;
      align-items:flex-start;
      justify-content:space-between;
      animation: toastIn .16s ease-out;
    }
    @keyframes toastIn{ from{ opacity:0; transform: translateY(10px);} to{ opacity:1; transform: translateY(0);} }
    .toast .tTitle{ font-weight: 800; font-size: 13px; }
    .toast .tBody{ margin-top: 2px; font-size: 12px; color: var(--muted); }
    .toast .x{
      border: 1px solid var(--border);
      background: transparent;
      color: var(--muted);
      border-radius: 12px;
      padding: 6px 8px;
      cursor:pointer;
    }
    .toast .x:hover{ color: var(--text); border-color: var(--border2); }

    .overlay{
      position: fixed;
      inset: 0;
      display: none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      background:
        radial-gradient(1100px 700px at 50% 20%, rgba(124,108,255,.18), transparent 55%),
        rgba(0,0,0,.55);
      backdrop-filter: blur(14px);
      z-index: 10000;
    }
    [data-theme="light"] .overlay{
      background:
        radial-gradient(1100px 700px at 50% 20%, rgba(124,108,255,.16), transparent 55%),
        rgba(0,0,0,.20);
      backdrop-filter: blur(10px);
    }
    .loginCard{
      width: min(520px, 100%);
      border: 1px solid var(--border);
      border-radius: 20px;
      background: color-mix(in oklab, var(--surface) 88%, transparent);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .loginCard h2{
      margin: 0 0 6px 0;
      font-size: 18px;
      letter-spacing: -.2px;
    }
    .loginCard p{
      margin: 0 0 14px 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }
    .loginRow{
      display:flex;
      gap: 10px;
      align-items:flex-end;
      flex-wrap:wrap;
    }
    .loginRow .field{ flex:1 1 260px; margin:0; }
    .loginFoot{
      margin-top: 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
      color: var(--muted);
      font-size: 12px;
    }

    .modOverlay{ display:none; }
    .modCard{
      width:min(520px, 100%);
      border: 1px solid var(--border);
      border-radius: 20px;
      background: color-mix(in oklab, var(--surface) 90%, transparent);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .modTitle{ margin:0 0 6px 0; font-size: 18px; letter-spacing: -.2px; }
    .modHint{ margin:0; color: var(--muted); font-size: 13px; line-height: 1.35; }
    .spinRow{ display:flex; align-items:center; gap: 12px; margin-top: 14px; }
    .spinner{
      width: 34px; height: 34px;
      border-radius: 999px;
      border: 3px solid rgba(128,128,128,.25);
      border-top-color: color-mix(in oklab, var(--accent) 60%, var(--text));
      animation: spin 1s linear infinite;
    }
    @keyframes spin{ to { transform: rotate(360deg); } }

    .modProgress{ margin-top: 14px; display:flex; flex-direction:column; gap: 8px; }
    .modProgressTop{ display:flex; align-items:center; justify-content:space-between; gap: 10px; }
    .progressBar{
      width: 100%;
      height: 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: color-mix(in oklab, var(--surface2) 70%, transparent);
      overflow:hidden;
    }
    .progressFill{
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, color-mix(in oklab, var(--accent) 90%, transparent), color-mix(in oklab, var(--accent2) 70%, transparent));
      transition: width .2s ease;
    }

    .uiTip{
      position: fixed;
      z-index: 999999;
      max-width: 340px;
      padding: 10px 12px;
      border: 1px solid var(--border2);
      background: color-mix(in oklab, var(--surface) 90%, transparent);
      color: var(--text);
      border-radius: 14px;
      box-shadow: var(--shadow2);
      font-size: 13px;
      line-height: 1.25;
      opacity: 0;
      transform: translateY(6px);
      transition: opacity .12s ease, transform .12s ease;
      pointer-events:none;
      user-select:none;
      white-space: normal;
      backdrop-filter: blur(12px);
    }
    .uiTip.show{ opacity: 1; transform: translateY(0); }
    .uiTip .tTitle{ font-weight: 900; margin: 0 0 6px 0; font-size: 13px; }
    .uiTip .tBody{ margin: 0; color: var(--muted); font-size: 12.5px; }

    details summary{
      cursor:pointer;
      color: var(--muted);
      font-size: 12px;
      user-select:none;
    }
    details summary:hover{ color: var(--text); }
    details .detailsBody{
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: color-mix(in oklab, var(--surface2) 60%, transparent);
    }

    @media (prefers-reduced-motion: reduce){
      *{ transition:none !important; animation:none !important; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="shell">
      <div class="topbar">
        <div class="brand">
          <div class="logo" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M7.8 3h8.4c1 0 1.8.8 1.8 1.8v8.4c0 1-.8 1.8-1.8 1.8H7.8c-1 0-1.8-.8-1.8-1.8V4.8C6 3.8 6.8 3 7.8 3Z" stroke="rgba(255,255,255,.92)" stroke-width="1.6"/>
              <path d="M9.1 8.3h5.8v5.8H9.1V8.3Z" fill="rgba(255,255,255,.9)" opacity=".13"/>
            </svg>
          </div>
          <div>
            <h1>Roblox Panel</h1>
            <div class="sub">Manage players, locks, and enforcement logs</div>
          </div>
        </div>

        <div class="statusPill" aria-live="polite">
          <span class="dot" id="statusDot"></span>
          <span style="font-size:12px;color:var(--muted);" id="status">‚Äî</span>
          <span class="pill"><span style="opacity:.8">Updated</span> <strong id="meta">‚Äî</strong></span>
        </div>

        <div class="topActions">
          <div class="seg" role="group" aria-label="Theme">
            <button id="themeLight" type="button" aria-pressed="false" data-tip="Theme ‚Äî Light">‚òÄÔ∏è</button>
            <button id="themeDark" type="button" aria-pressed="true" data-tip="Theme ‚Äî Dark">üåô</button>
            <button id="themeAuto" type="button" aria-pressed="false" data-tip="Theme ‚Äî Auto (system)">üñ•Ô∏è</button>
          </div>

          <div class="who" data-tip="Session ‚Äî Logged in username (local only)">
            <span class="k">üë§</span>
            <span class="v" id="whoami">‚Äî</span>
          </div>

          <button id="refresh" class="btn" type="button" data-tip="Refresh ‚Äî Reload players + logs from your Worker">‚Üª Refresh</button>
          <button id="lockBtn" class="btn ghost" type="button" data-tip="Lock ‚Äî Toggle lock state">üîì</button>
          <button id="logout" class="btn ghost" type="button" data-tip="Logout ‚Äî End this session on this device">üö™ Logout</button>
        </div>
      </div>

      <div class="content" id="app" style="display:none">
        <div class="panel">
          <div class="panelHead">
            <div>
              <h2>Settings</h2>
              <div class="hint">These are stored in your browser (localStorage). Your Worker validates actions using <span style="font-family:var(--mono)">ADMIN_KEY</span>.</div>
            </div>
            <button id="save" class="btn primary" type="button" data-tip="Save ‚Äî Store Worker URL + Admin Key in this browser">üíæ Save</button>
          </div>

          <div class="panelBody">
            <div class="field">
              <div class="label">
                <span>Worker Base URL</span>
                <span class="mono">e.g. https://panel.example.workers.dev</span>
              </div>
              <input id="workerBase" placeholder="https://panel.example.workers.dev" autocomplete="off" />
            </div>

            <div class="field">
              <div class="label">
                <span>Admin Key</span>
                <span class="mono">stored locally</span>
              </div>
              <input id="adminKey" placeholder="ADMIN_KEY (stored in your browser)" autocomplete="off" />
            </div>

            <div class="field">
              <div class="label">
                <span>Search</span>
                <span class="mono">name / display / id / by</span>
              </div>
              <input id="search" placeholder="Search name / display / id" autocomplete="off" />
            </div>

            <details>
              <summary>About logs (suspicious flags)</summary>
              <div class="detailsBody">
                We log new group members that have suspicious usernames or are in suspicious groups. Bots may appear ‚Äî ignore them.
              </div>
            </details>

            <div class="meta">
              <span class="pill" data-tip="Tips ‚Äî Quick shortcuts">‚å®Ô∏è <strong>Enter</strong> to login ‚Ä¢ <strong>Refresh</strong> has a cooldown</span>
              <span class="pill" data-tip="Privacy ‚Äî Data stays in your browser">üõ°Ô∏è <strong>Local</strong> settings only</span>
            </div>
          </div>
        </div>

        <div class="main">
          <div class="panel">
            <div class="listHead">
              <div class="left">
                <h3>Active users</h3>
                <span class="count" id="activeCount">0</span>
              </div>
              <span class="pill" data-tip="Selection ‚Äî Click a user card to enable actions">üß≠ <strong>Select</strong> a user</span>
            </div>
            <div class="scroll" id="activeList"></div>
          </div>

          <div class="panel">
            <div class="listHead">
              <div class="left">
                <h3>Logs</h3>
                <span class="count" id="logCount">0</span>
              </div>
              <span class="pill" data-tip="Unban ‚Äî Select a BAN log entry to enable unban buttons">üìú <strong>Select</strong> a log</span>
            </div>
            <div class="scroll" id="logList"></div>
          </div>

          <div class="actionDock" style="grid-column: 1 / -1;">
            <div class="dockRow">
              <div class="left">
                <button id="kick" class="btn" type="button" data-tip="Kick ‚Äî Kick selected active user">üë¢ Kick</button>
                <button id="kickReason" class="btn" type="button" data-tip="Kick w/ reason ‚Äî Prompts for a reason">üìù Kick w/ reason</button>
                <button id="ban" class="btn danger" type="button" data-tip="Ban ‚Äî Ban selected active user">‚õî Ban</button>
                <button id="banReason" class="btn danger" type="button" data-tip="Ban w/ reason ‚Äî Prompts for a reason">üßæ Ban w/ reason</button>
              </div>
              <div class="right">
                <button id="unban" class="btn primary" type="button" data-tip="Unban ‚Äî Select a BAN log entry to unban">‚úÖ Unban</button>
                <button id="unbanReason" class="btn primary" type="button" data-tip="Unban w/ note ‚Äî Prompts for a note">üóíÔ∏è Unban w/ note</button>
              </div>
            </div>
            <div class="dockHint" id="dockHint">Select an active user to kick/ban. Select a BAN log entry to unban.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="overlay" id="loginOverlay" style="display:none">
    <div class="loginCard">
      <h2>Panel Login</h2>
      <p>Enter your panel username to continue. Usernames are case-insensitive.</p>
      <div class="loginRow">
        <div class="field">
          <div class="label"><span>Username</span></div>
          <input id="loginUser" placeholder="e.g. Username" autocomplete="off" />
        </div>
        <button id="loginBtn" class="btn primary" type="button">üîì Login</button>
      </div>
      <div class="loginFoot">
        <span id="loginStatus"></span>
        <span>Tip: Press <span style="font-family:var(--mono)">Enter</span></span>
      </div>
    </div>
  </div>

  <div class="overlay modOverlay" id="modOverlay" style="display:none">
    <div class="modCard">
      <h2 class="modTitle">Moderating user</h2>
      <p class="modHint">This may take some time. Please keep this tab open.</p>

      <div class="spinRow">
        <div class="spinner" aria-hidden="true"></div>
        <div style="display:flex;flex-direction:column;gap:4px;min-width:0">
          <div style="font-size:12px;color:var(--muted)" id="modOverlaySub">Applying action‚Ä¶</div>
          <div class="modProgress" aria-label="Moderation progress">
            <div class="modProgressTop">
              <span style="font-size:12px;color:var(--muted)" id="modStep">Starting‚Ä¶</span>
              <span style="font-size:12px;color:var(--muted)" id="modPct">0%</span>
            </div>
            <div class="progressBar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
              <div class="progressFill" id="modFill"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toastWrap" id="toasts"></div>

  <script>
    const ALLOWED_USERNAMES = new Set(["eagla","nebula","specimen","arrow","damage","caprie"]);
    const STAFF_IDS = new Set([8007453710,4976035348,154251360,9930928180,485280430]);

    const NAME_CACHE_KEY = "panel_name_cache_v1";

    function loadNameCache(){
      try{
        const raw = localStorage.getItem(NAME_CACHE_KEY);
        const obj = raw ? JSON.parse(raw) : {};
        return (obj && typeof obj === "object") ? obj : {};
      } catch { return {}; }
    }

    function saveNameCache(cache){
      try{ localStorage.setItem(NAME_CACHE_KEY, JSON.stringify(cache)); } catch {}
    }

    function cacheNameFrom(user){
      if (!user) return;
      const id = Number(user.userId || 0);
      if (!id) return;
      const username = String(user.username || "");
      const displayName = String(user.displayName || "");
      if (!username && !displayName) return;
      const cache = loadNameCache();
      cache[String(id)] = { username, displayName, at: Date.now() };
      saveNameCache(cache);
    }

    function resolveName(userId, username, displayName){
      const u = String(username || "");
      const d = String(displayName || "");
      if (u || d) return { username: u, displayName: d };

      const found = activePlayers && activePlayers.find(p => Number(p.userId) === Number(userId));
      if (found && (found.username || found.displayName)){
        cacheNameFrom(found);
        return { username: String(found.username || ""), displayName: String(found.displayName || "") };
      }

      const cache = loadNameCache();
      const hit = cache[String(Number(userId))];
      if (hit && (hit.username || hit.displayName)){
        return { username: String(hit.username || ""), displayName: String(hit.displayName || "") };
      }

      return { username: "", displayName: "" };
    }

    const els = {
      app: document.getElementById("app"),
      loginOverlay: document.getElementById("loginOverlay"),
      loginUser: document.getElementById("loginUser"),
      loginBtn: document.getElementById("loginBtn"),
      loginStatus: document.getElementById("loginStatus"),
      logout: document.getElementById("logout"),
      whoami: document.getElementById("whoami"),

      status: document.getElementById("status"),
      statusDot: document.getElementById("statusDot"),
      meta: document.getElementById("meta"),

      workerBase: document.getElementById("workerBase"),
      adminKey: document.getElementById("adminKey"),
      search: document.getElementById("search"),
      save: document.getElementById("save"),
      refresh: document.getElementById("refresh"),
      lockBtn: document.getElementById("lockBtn"),
      clearLogsBtn: document.getElementById("clearLogsBtn"),

      activeList: document.getElementById("activeList"),
      logList: document.getElementById("logList"),
      activeCount: document.getElementById("activeCount"),
      logCount: document.getElementById("logCount"),
      toasts: document.getElementById("toasts"),
      modOverlay: document.getElementById("modOverlay"),
      modOverlaySub: document.getElementById("modOverlaySub"),
      modFill: document.getElementById("modFill"),
      modPct: document.getElementById("modPct"),
      modStep: document.getElementById("modStep"),

      kick: document.getElementById("kick"),
      kickReason: document.getElementById("kickReason"),
      ban: document.getElementById("ban"),
      banReason: document.getElementById("banReason"),
      unban: document.getElementById("unban"),
      unbanReason: document.getElementById("unbanReason"),

      themeLight: document.getElementById("themeLight"),
      themeDark: document.getElementById("themeDark"),
      themeAuto: document.getElementById("themeAuto"),
    };

    function esc(s){
      return String(s ?? "").replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
    }

    function toast(kind, title, body){
      const div = document.createElement("div");
      div.className = "toast " + (kind || "");
      div.innerHTML = `
        <div style="min-width:0">
          <div class="tTitle">${esc(title || "")}</div>
          ${body ? `<div class="tBody">${esc(body)}</div>` : ""}
        </div>
        <button class="x" type="button" aria-label="Close">‚úï</button>
      `;
      div.querySelector(".x").onclick = () => div.remove();
      els.toasts.appendChild(div);
      setTimeout(() => { if (div.isConnected) div.remove(); }, 3200);
    }

    function setStatus(state, text){
      els.status.textContent = text || "";
      if (state === "ok"){
        els.statusDot.className = "dot ok";
      } else if (state === "error"){
        els.statusDot.className = "dot err";
      } else if (state === "loading"){
        els.statusDot.className = "dot load";
      } else {
        els.statusDot.className = "dot";
      }
    }

    function setModerationProgress(pct, stepText){
      const p = Math.max(0, Math.min(100, Math.floor(Number(pct) || 0)));
      if (els.modFill) els.modFill.style.width = p + "%";
      if (els.modPct) els.modPct.textContent = p + "%";
      if (els.modStep) els.modStep.textContent = stepText || "";
      const bar = els.modOverlay ? els.modOverlay.querySelector(".progressBar") : null;
      if (bar) bar.setAttribute("aria-valuenow", String(p));
    }

    function showModerationOverlay(show, subText){
      if (!els.modOverlay) return;
      if (show){
        if (els.modOverlaySub) els.modOverlaySub.textContent = subText || "Applying action‚Ä¶";
        setModerationProgress(0, "Starting‚Ä¶");
        els.modOverlay.style.display = "flex";
      } else {
        els.modOverlay.style.display = "none";
      }
    }

    function applyTheme(mode){
      localStorage.setItem("panel_theme_mode", mode);
      els.themeLight.setAttribute("aria-pressed", mode === "light");
      els.themeDark.setAttribute("aria-pressed", mode === "dark");
      els.themeAuto.setAttribute("aria-pressed", mode === "auto");
      if (mode === "auto"){
        document.documentElement.removeAttribute("data-theme");
        return;
      }
      document.documentElement.setAttribute("data-theme", mode);
    }
    applyTheme(localStorage.getItem("panel_theme_mode") || "dark");
    els.themeLight.onclick = () => applyTheme("light");
    els.themeDark.onclick = () => applyTheme("dark");
    els.themeAuto.onclick = () => applyTheme("auto");

    function normalizeUser(s){ return String(s || "").trim().toLowerCase(); }
    function isLoggedIn(){ return localStorage.getItem("panel_logged_in") === "1"; }
    function setLoggedIn(username){
      localStorage.setItem("panel_logged_in", "1");
      localStorage.setItem("panel_login_user", String(username || ""));
    }
    function clearLoggedIn(){
      localStorage.removeItem("panel_logged_in");
      localStorage.removeItem("panel_login_user");
    }
    function getLoginUser(){ return localStorage.getItem("panel_login_user") || ""; }

    function updateWhoAmI(){
      const u = String(getLoginUser() || "").trim();
      els.whoami.textContent = u ? u : "‚Äî";
    }

    function showLogin(){
      els.whoami.textContent = "‚Äî";
      els.app.style.display = "none";
      els.loginOverlay.style.display = "flex";
      els.loginStatus.textContent = "";
      els.loginUser.value = "";
      els.loginUser.focus();
    }
    function showApp(){
      els.loginOverlay.style.display = "none";
      els.app.style.display = "grid";
    }

    function attemptLogin(){
      const u = normalizeUser(els.loginUser.value);
      if (!u){
        els.loginStatus.textContent = "Enter a username.";
        toast("err", "Login", "Enter a username.");
        return;
      }
      if (!ALLOWED_USERNAMES.has(u)){
        els.loginStatus.textContent = "Invalid username.";
        toast("err","Login denied","That username is not allowed.");
        return;
      }
      setLoggedIn(u);
      updateWhoAmI();
      toast("ok","Logged in","Welcome.");
      showApp();
      initPanel();
    }

    els.loginBtn.onclick = attemptLogin;
    els.loginUser.addEventListener("keydown", (e) => { if (e.key === "Enter") attemptLogin(); });
    els.logout.onclick = () => {
      if (!confirm("Log out?")) return;
      clearLoggedIn();
      toast("ok","Logged out","");
      showLogin();
    };

    function isStaff(userId){ return STAFF_IDS.has(Number(userId)); }

    function baseUrl(){
      const raw = (els.workerBase.value || "").trim().replace(/\/+$/,"");
      return raw;
    }
    function endpoint(path){ return baseUrl() + path; }

    let activePlayers = [];
    let logs = [];

    function mergeLogs(items){
      const arr = Array.isArray(items) ? items.slice() : [];
      function createdAtNum(e){
        const v = e && (e.createdAt ?? e.ackedAt ?? e.time ?? 0);
        const n = Number(v);
        return Number.isFinite(n) ? n : 0;
      }
      arr.sort((a,b) => createdAtNum(b) - createdAtNum(a));
      return arr;
    }

    let selectedActiveUserId = null;
    let selectedLogId = null;
    let uiLocked = false;
    let refreshCooldownTimer = null;

    function startCooldown(btn, seconds, label){
      const until = Date.now() + seconds * 1000;
      btn.disabled = true;
      const orig = btn.textContent;
      const tick = () => {
        const left = Math.max(0, Math.ceil((until - Date.now()) / 1000));
        if (left > 0){
          btn.textContent = `‚è≥ ${label} (${left}s)`;
          refreshCooldownTimer = setTimeout(tick, 250);
        } else {
          btn.textContent = orig;
          btn.disabled = false;
          if (refreshCooldownTimer) clearTimeout(refreshCooldownTimer);
          refreshCooldownTimer = null;
        }
      };
      tick();
    }

    function beginVerifyLock(){
      uiLocked = true;
      selectedActiveUserId = null;
      selectedLogId = null;
      renderActive();
      renderLogs();
      updateButtons();
      setStatus("loading","Verifying‚Ä¶");
    }
    function endVerifyLock(){
      uiLocked = false;
      updateButtons();
      setStatus("ok","Ready");
    }

    function setCounts(){
      els.activeCount.textContent = String(activePlayers.length || 0);
      const nonPending = logs.filter(e => String(e.status||"").toLowerCase() !== "pending").length;
      els.logCount.textContent = String(nonPending || 0);
    }

    function matchSearch(p){
      const q = normalizeUser(els.search.value);
      if (!q) return true;
      const id = String(p.userId || "");
      const u = normalizeUser(p.username || "");
      const d = normalizeUser(p.displayName || "");
      const by = normalizeUser(p.by || "");
      return id.includes(q) || u.includes(q) || d.includes(q) || by.includes(q);
    }

    function makePlayerCardHTML(p){
      const name = esc(p.displayName || p.username || ("User " + p.userId));
      const handle = esc(p.username || "");
      const team = p.team ? `<span class="chip accent">üè∑Ô∏è ${esc(p.team)}</span>` : "";
      const place = p.placeId ? `<span class="chip">üìç ${esc(p.placeId)}</span>` : "";
      const staff = isStaff(p.userId) ? `<span class="chip warn">üõ°Ô∏è STAFF</span>` : "";
      return `
        <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px">
          <div style="min-width:0">
            <div style="font-weight:850;letter-spacing:-.1px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${name}</div>
            <div style="font-size:12px;color:var(--muted);margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${handle ? "@" + handle : ""}</div>
          </div>
          <div class="chipRow" style="justify-content:flex-end;margin-top:0">
            ${staff}
          </div>
        </div>
        <div class="chipRow">
          <span class="chip">üÜî ${Number(p.userId) || ""}</span>
          ${team}
          ${place}
        </div>
      `;
    }

    function makeLogCardHTML(e){
      const resolved = resolveName(e.userId, e.username, e.displayName);
      const name = esc(resolved.displayName || resolved.username || ("User " + e.userId));
      const handle = esc(resolved.username || "");
      const actionRaw = String(e.action || "");
      const action = esc(actionRaw.toUpperCase());
      const by = esc(e.by || "");
      const reason = esc(e.reason || "");
      const when = e.createdAt ? new Date(Number(e.createdAt)).toLocaleString() : "";

      const st = String(e.status || "").toLowerCase();
      const statusText = st === "applied" ? "SUCCESS" : st === "failed" ? "NOT SUCCESSFUL" : "";

      const tag = String(e.tag || "");
      const flags = Array.isArray(e.flags) ? e.flags : [];
      const groups = Array.isArray(e.flagGroups) ? e.flagGroups : [];
      const suspicious = (tag.toLowerCase() === "suspicious") || (String(actionRaw).toLowerCase() === "suspicious");

      const chips = [];
      if (action) chips.push(`<span class="chip accent">‚ö° ${action}</span>`);
      if (suspicious) chips.push(`<span class="chip warn">‚ö†Ô∏è SUSPICIOUS</span>`);
      else if (tag) chips.push(`<span class="chip">üè∑Ô∏è ${esc(tag)}</span>`);
      if (statusText) chips.push(`<span class="chip ${st === "applied" ? "ok" : "fail"}">${st === "applied" ? "‚úÖ" : "‚ùå"} ${esc(statusText)}</span>`);
      if (by) chips.push(`<span class="chip">üßë ${by}</span>`);
      if (when) chips.push(`<span class="chip">üïí ${esc(when)}</span>`);
      if (flags.length) chips.push(`<span class="chip warn">üö© ${esc(flags.join(", "))}</span>`);
      if (groups.length) chips.push(`<span class="chip warn">üë• ${esc(groups.join(", "))}</span>`);

      return `
        <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px">
          <div style="min-width:0">
            <div style="font-weight:850;letter-spacing:-.1px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${name}</div>
            <div style="font-size:12px;color:var(--muted);margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${handle ? "@" + handle : ""}</div>
          </div>
        </div>
        <div class="chipRow">${chips.join("")}</div>
        <div class="chipRow">
          <span class="chip">üÜî ${Number(e.userId) || ""}</span>
          ${reason ? `<span class="chip">üìù ${reason}</span>` : ""}
        </div>
      `;
    }

    function renderActive(){
      els.activeList.innerHTML = "";
      setCounts();

      const list = activePlayers.filter(matchSearch);
      if (!list.length){
        els.activeList.innerHTML = `<div class="empty">No players match.</div>`;
        return;
      }

      for (const p of list){
        const staff = isStaff(p.userId);
        const div = document.createElement("div");
        div.className = "card" +
          (Number(p.userId) === Number(selectedActiveUserId) ? " selected" : "") +
          (staff ? " staffCard" : "");
        div.innerHTML = makePlayerCardHTML(p);
        if (!staff && !uiLocked){
          div.onclick = () => {
            selectedActiveUserId = Number(p.userId);
            selectedLogId = null;
            renderActive();
            renderLogs();
            updateButtons();
          };
        }
        els.activeList.appendChild(div);
      }
    }

    function renderLogs(){
      els.logList.innerHTML = "";
      setCounts();

      const list = logs.filter(matchSearch).filter(e => String(e.status||"").toLowerCase() !== "pending");
      if (!list.length){
        els.logList.innerHTML = `<div class="empty">No logs.</div>`;
        return;
      }

      for (const e of list){
        const st = String(e.status || "").toLowerCase();
        const suspicious = (String(e.tag||"").toLowerCase() === "suspicious") || (String(e.action||"").toLowerCase() === "suspicious");
        const extra = suspicious ? " logSus" : st === "applied" ? " logOk" : st === "failed" ? " logFail" : "";

        const div = document.createElement("div");
        div.className = "card" + extra + (String(e.id) === String(selectedLogId) ? " selected" : "");
        div.innerHTML = makeLogCardHTML(e);
        if (!uiLocked){
          div.onclick = () => {
            selectedLogId = String(e.id);
            selectedActiveUserId = null;
            renderActive();
            renderLogs();
            updateButtons();
          };
        }
        els.logList.appendChild(div);
      }
    }

    function updateButtons(){
      if (uiLocked){
        els.kick.disabled = true; els.kickReason.disabled = true; els.ban.disabled = true; els.banReason.disabled = true;
        els.unban.disabled = true; els.unbanReason.disabled = true;
        return;
      }
      const active = activePlayers.find(p => Number(p.userId) === Number(selectedActiveUserId)) || null;
      const logSel = logs.find(e => String(e.id) === String(selectedLogId)) || null;

      const activeOk = !!active && !isStaff(active.userId);
      els.kick.disabled = !activeOk;
      els.kickReason.disabled = !activeOk;
      els.ban.disabled = !activeOk;
      els.banReason.disabled = !activeOk;

      const canUnban = !!logSel && String(logSel.action || "").toLowerCase() === "ban" && !isStaff(logSel.userId);
      els.unban.disabled = !canUnban;
      els.unbanReason.disabled = !canUnban;
    }

    let lockState = { locked:false, by:"", at:0 };
    let lockLastAt = 0;

    function fmtWhen(ms){
      if (!ms) return "";
      try { return new Date(Number(ms)).toLocaleString(); } catch { return ""; }
    }

    function renderLockState(){
      const locked = !!lockState.locked;
      if (els.lockBtn){
        els.lockBtn.textContent = locked ? "üîí Locked" : "üîì Unlocked";
        const who = (lockState.by || "").trim();
        const when = lockState.at ? fmtWhen(lockState.at) : "";
        const stateText = locked ? "LOCKED" : "UNLOCKED";
        const byText = who ? (" by " + who) : "";
        const atText = when ? (" ‚Ä¢ " + when) : "";
        const actionHint = locked ? "Click to unlock (teleport players to main place)." : "Click to lock (send joiners + players to lock place).";
        els.lockBtn.setAttribute("data-tip", "Lock ‚Äî " + stateText + byText + atText + " ‚Äî " + actionHint);
        els.lockBtn.classList.toggle("danger", locked);
        els.lockBtn.classList.toggle("ghost", !locked);
      }
    }

    async function fetchLockState(){
      try{
        const url = endpoint("/lockState") + (endpoint("/lockState").includes("?") ? "&" : "?") + "t=" + Date.now();
        const res = await fetch(url, { cache: "no-store" });
        const body = await res.json().catch(()=>null);
        if (res.ok && body && body.ok){
          lockState = { locked: !!body.locked, by: String(body.by||""), at: Number(body.at||0) };
          renderLockState();

          if (lockState.at && lockState.at !== lockLastAt){
            lockLastAt = lockState.at;
            fetchPlayers().catch(()=>{});
          }
        }
      }catch{}
    }

    async function setLockState(locked){
      const adminKey = els.adminKey.value.trim();
      if (!adminKey){ toast("err","Missing ADMIN_KEY","Enter ADMIN_KEY first."); return; }
      const user = String(getLoginUser() || "").trim();
      if (!user){ toast("err","Not logged in","Log in first."); return; }

      try{
        const res = await fetch(endpoint("/admin/setLock"), {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "x-admin-key": adminKey,
            "x-admin-user": user
          },
          body: JSON.stringify({ locked: !!locked, user })
        });
        const body = await res.json().catch(()=>null);
        if (!res.ok){
          if (body && body.error === "Cooldown"){
            const s = Math.ceil(Number(body.waitMs || 0) / 1000);
            toast("err","Cooldown","Try again in " + s + "s");
          }else{
            toast("err","Lock failed", (body && body.error) ? body.error : ("HTTP " + res.status));
          }
          return;
        }
        lockState = { locked: !!body.locked, by: String(body.by||user), at: Number(body.at||Date.now()) };
        renderLockState();
        toast("ok", lockState.locked ? "Game locked" : "Game unlocked", "");
      }catch(e){
        toast("err","Lock failed", e.message);
      }
    }

    async function fetchPlayers(){
      const url = endpoint("/players");
      setStatus("loading","Loading players‚Ä¶");
      const res = await fetch(url, { cache:"no-store" });
      if (!res.ok) throw new Error("Players HTTP " + res.status);
      const data = await res.json();
      activePlayers = Array.isArray(data.players) ? data.players : [];
      try{ for (const p of activePlayers) cacheNameFrom(p); } catch {}
      els.meta.textContent = `Updated: ${data.updatedAt || "?"} ‚Ä¢ Players: ${data.totalPlayers ?? activePlayers.length}`;
      setStatus("ok","OK");
      return activePlayers;
    }

    async function fetchLogs(){
      const url = endpoint("/history") + (endpoint("/history").includes("?") ? "&" : "?") + "t=" + Date.now();
      const res = await fetch(url, { cache:"no-store" });
      if (!res.ok) throw new Error("Logs HTTP " + res.status);
      const data = await res.json();
      logs = mergeLogs(Array.isArray(data.items) ? data.items : []);
      if (selectedLogId && !logs.some(e => String(e.id) === String(selectedLogId))){
        selectedLogId = null;
      }
      renderLogs();
      updateButtons();
      return logs;
    }

    async function fetchPlayersOnce(){
      const url = endpoint("/players");
      const res = await fetch(url, { cache:"no-store" });
      if (!res.ok) throw new Error("Players HTTP " + res.status);
      const data = await res.json();
      return Array.isArray(data.players) ? data.players : [];
    }

    async function sendModeration(action, user, reason){
      if (!user) return { ok:false };
      const userId = Number(user.userId || 0);

      if (isStaff(userId)) {
        toast("err", "Blocked", "That user is STAFF and cannot be moderated.");
        return { ok:false };
      }

      const adminKey = els.adminKey.value.trim();
      if (!adminKey) {
        toast("err", "Missing ADMIN_KEY", "Enter ADMIN_KEY first.");
        return { ok:false };
      }

      try{ cacheNameFrom(user); } catch {}

      const payload = {
        action,
        userId,
        reason: String(reason || ""),
        by: String(getLoginUser() || ""),
        username: String(user.username || ""),
        displayName: String(user.displayName || "")
      };

      let res, body = null;
      try{
        res = await fetch(endpoint("/admin/moderate"), {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "x-admin-key": adminKey
          },
          body: JSON.stringify(payload)
        });
        try { body = await res.json(); } catch { body = null; }
      } catch(e){
        toast("err", "Request failed", e.message);
        return { ok:false };
      }

      if (!res || !res.ok) {
        toast("err", "Request rejected", (body && body.error) ? body.error : ("HTTP " + (res ? res.status : "?")));
        return { ok:false };
      }

      return { ok:true, id: body && body.id ? String(body.id) : "" };
    }

    async function enforceAndVerify(action, user, reason){
      const act = String(action || "").toLowerCase();
      const userId = Number(user && user.userId || 0);
      if (act === "unban"){
        const sent = await sendModeration("unban", user, reason || "");
        return (sent && sent.ok) ? { ok:true, id: sent.id || "" } : { ok:false, message: "unban failed" };
      }
      if (!userId) return { ok:false, message: "missing userId" };

      const started = Date.now();
      const hardTimeoutMs = 60000;
      const resendEveryMs = 500;
      const checkEveryMs  = 400;
      const refreshUiEveryMs = 700;

      function updateOverlay(step){
        const pct = Math.min(99, Math.floor(((Date.now() - started) / hardTimeoutMs) * 100));
        setModerationProgress(pct, step || "Working‚Ä¶");
        if (els.modOverlaySub) els.modOverlaySub.textContent = step || "Working‚Ä¶";
      }

      let lastSendAt = 0;
      let lastUiAt = 0;
      let lastId = "";
      let _stage = "";

      function setStage(msg){
        if (_stage === msg) return;
        _stage = msg;
        updateOverlay(msg);
      }

      function normStr(v){ return String(v || "").trim(); }
      function findLogById(id){
        if (!id) return null;
        return logs.find(e => String(e && e.id) === String(id)) || null;
      }
      function findLogBySignature(){
        const targetAction = normStr(action).toLowerCase();
        const targetUserId = Number(userId) || 0;
        const targetBy = normStr(getLoginUser());
        const targetReason = normStr(reason);

        let best = null;
        for (const e of logs){
          if (!e) continue;
          if (normStr(e.action).toLowerCase() !== targetAction) continue;
          if (Number(e.userId || 0) !== targetUserId) continue;
          if (targetBy && normStr(e.by) !== targetBy) continue;
          if (targetReason && normStr(e.reason) !== targetReason) continue;
          const t = Number(e.createdAt || e.ackedAt || 0) || 0;
          if (t < started - 1500) continue;
          if (!best) best = e;
          else {
            const bt = Number(best.createdAt || best.ackedAt || 0) || 0;
            if (t > bt) best = e;
          }
        }
        return best;
      }

      async function refreshUi(){
        try{
          await fetchPlayers();
          await fetchLogs();
          renderActive();
          renderLogs();
          setCounts();
          updateButtons();
        } catch {}
      }

      async function isStillHere(){
        try{
          const players = await fetchPlayersOnce();
          return players.some(p => Number(p.userId) === userId);
        } catch {
          return true;
        }
      }

      updateOverlay("Preparing‚Ä¶");

      if (!(await isStillHere())){
        setModerationProgress(100, "Already gone");
        await fetchPlayers();
        await fetchLogs();
        renderActive();
        updateButtons();
        return { ok:true, id: "" };
      }

      while (Date.now() - started < hardTimeoutMs){
        const now = Date.now();

        if (!lastId && (now - lastSendAt >= resendEveryMs)) {
          updateOverlay("Sending request to server‚Ä¶");
          const sent = await sendModeration(act, user, reason || "");
          lastSendAt = now;
          if (sent && sent.ok && sent.id) lastId = String(sent.id);
        }

        if (now - lastUiAt >= refreshUiEveryMs){
          lastUiAt = now;
          setStage("Moderating‚Ä¶");
          await refreshUi();
        }

        let logItem = findLogById(lastId);
        if (!logItem) logItem = findLogBySignature();

        if (logItem){
          const st = String(logItem.status || "").toLowerCase();
          if (st === "applied"){
            setModerationProgress(100, "Success");
            await refreshUi();
            return { ok:true, id: String(logItem.id || lastId || "") };
          }
          if (st === "failed"){
            setModerationProgress(100, "Not successful");
            await refreshUi();
            return { ok:false, id: String(logItem.id || lastId || ""), message: "failed" };
          }
        }

        if (!window.__goneStreak) window.__goneStreak = {};
        const keyGone = String(action) + ":" + String(userId);
        const still = await isStillHere();

        if (!still && (act === "kick" || act === "ban")){
          window.__goneStreak[keyGone] = (window.__goneStreak[keyGone] || 0) + 1;
          if (window.__goneStreak[keyGone] >= 3){
            setModerationProgress(100, "Success");
            await refreshUi();
            return { ok:true, id: String(lastId || "") };
          }
        } else {
          window.__goneStreak[keyGone] = 0;
        }

        setStage("Moderating‚Ä¶");
        await new Promise(r => setTimeout(r, checkEveryMs));
      }

      setModerationProgress(100, "Timed out");
      return { ok:false, timeout:true, message: "Timed out waiting for confirmation. Try again or use an in-game moderation method." };
    }

    function getSelectedActive(){ return activePlayers.find(p => Number(p.userId) === Number(selectedActiveUserId)) || null; }
    function getSelectedLog(){ return logs.find(e => String(e.id) === String(selectedLogId)) || null; }

    async function refreshAll(){
      await fetchPlayers();
      await fetchLogs();
      renderActive();
      renderLogs();
      setCounts();
      updateButtons();
    }

    els.search.addEventListener("input", () => { renderActive(); renderLogs(); updateButtons(); });

    els.save.onclick = () => {
      localStorage.setItem("worker_base_v1", baseUrl());
      localStorage.setItem("admin_key_v1", els.adminKey.value.trim());
      toast("ok","Saved","Worker Base + Admin Key stored in this browser.");
      setStatus("ok","Saved");
    };

    els.refresh.onclick = async () => {
      if (els.refresh.disabled) return;
      startCooldown(els.refresh, 10, "Refresh");
      try{
        await refreshAll();
      } catch(e){
        setStatus("error", "Refresh failed");
        toast("err","Refresh failed", e.message);
      }
    };

    els.lockBtn && (els.lockBtn.onclick = async () => {
      await setLockState(!lockState.locked);
      setTimeout(() => { fetchLockState(); }, 500);
    });

    async function runAction(action, user, reason, onSuccess){
      const act = String(action || "").toLowerCase();
      if (act === "kick" || act === "ban"){
        showModerationOverlay(true, "Moderating user‚Ä¶ this may take some time.");
      }
      beginVerifyLock();
      try{
        const v = await enforceAndVerify(action, user, reason || "");
        if (v.ok){
          toast("ok","Action approved","");
          if (typeof onSuccess === "function") onSuccess();
          await fetchLogs();
          await fetchPlayers();
        } else {
          toast("err", v.timeout ? "Timed out" : "Failed", v.message || "");
        }
      } finally {
        endVerifyLock();
        showModerationOverlay(false, "");
      }
    }

    els.kick.onclick = async () => {
      const p = getSelectedActive(); if (!p) return;
      await runAction("kick", p, "", null);
    };
    els.kickReason.onclick = async () => {
      const p = getSelectedActive(); if (!p) return;
      const r = prompt("Kick reason?") || "";
      await runAction("kick", p, r, null);
    };
    els.ban.onclick = async () => {
      const p = getSelectedActive(); if (!p) return;
      await runAction("ban", p, "", null);
    };
    els.banReason.onclick = async () => {
      const p = getSelectedActive(); if (!p) return;
      const r = prompt("Ban reason?") || "";
      await runAction("ban", p, r, null);
    };
    els.unban.onclick = async () => {
      const e = getSelectedLog(); if (!e) return;
      const user = { userId: e.userId, username: e.username || "", displayName: e.displayName || "" };
      await runAction("unban", user, "", () => { selectedLogId = null; });
    };
    els.unbanReason.onclick = async () => {
      const e = getSelectedLog(); if (!e) return;
      const r = prompt("Unban note?") || "";
      const user = { userId: e.userId, username: e.username || "", displayName: e.displayName || "" };
      await runAction("unban", user, r, () => { selectedLogId = null; });
    };

    let _uiTipEl = null;
    let _uiTipTarget = null;

    function ensureTip(){
      if (_uiTipEl) return _uiTipEl;
      _uiTipEl = document.createElement("div");
      _uiTipEl.className = "uiTip";
      _uiTipEl.innerHTML = '<div class="tTitle" id="uiTipTitle"></div><div class="tBody" id="uiTipBody"></div>';
      document.body.appendChild(_uiTipEl);
      return _uiTipEl;
    }

    function setTipContent(text){
      const el = ensureTip();
      const titleEl = el.querySelector("#uiTipTitle");
      const bodyEl  = el.querySelector("#uiTipBody");
      const raw = String(text || "").trim();
      const parts = raw.split(" ‚Äî ");
      const t = (parts[0] || "").trim();
      const b = (parts.slice(1).join(" ‚Äî ") || "").trim();
      if (titleEl) titleEl.textContent = t || "Info";
      if (bodyEl) bodyEl.textContent = b || "";
    }

    function positionTip(clientX, clientY){
      const el = ensureTip();
      const pad = 12;
      const vw = window.innerWidth || 0;
      const vh = window.innerHeight || 0;
      let x = clientX + 14;
      let y = clientY + 14;

      el.style.left = "0px";
      el.style.top = "0px";
      el.style.maxWidth = "340px";
      el.classList.add("show");

      const rect = el.getBoundingClientRect();
      if (x + rect.width + pad > vw) x = Math.max(pad, clientX - rect.width - 14);
      if (y + rect.height + pad > vh) y = Math.max(pad, clientY - rect.height - 14);

      el.style.left = x + "px";
      el.style.top  = y + "px";
    }

    function showTipFor(target, clientX, clientY){
      const text = (target && target.getAttribute) ? target.getAttribute("data-tip") : "";
      if (!text) return;
      _uiTipTarget = target;
      setTipContent(text);
      positionTip(clientX, clientY);
    }

    function hideTip(){
      if (!_uiTipEl) return;
      _uiTipEl.classList.remove("show");
      _uiTipTarget = null;
    }

    function initTooltips(){
      ensureTip();
      const candidates = Array.from(document.querySelectorAll("[data-tip]"));
      for (const el of candidates){
        el.addEventListener("mouseenter", (e) => {
          const t = e.currentTarget;
          const tip = t.getAttribute("data-tip") || "";
          if (!tip) return;
          showTipFor(t, e.clientX, e.clientY);
        });
        el.addEventListener("mousemove", (e) => {
          if (_uiTipTarget !== e.currentTarget) return;
          positionTip(e.clientX, e.clientY);
        });
        el.addEventListener("mouseleave", () => hideTip());
        el.addEventListener("focus", (e) => {
          const r = e.currentTarget.getBoundingClientRect();
          const cx = Math.round(r.left + Math.min(40, r.width/2));
          const cy = Math.round(r.top + r.height + 6);
          showTipFor(e.currentTarget, cx, cy);
        });
        el.addEventListener("blur", () => hideTip());
      }
      window.addEventListener("scroll", () => hideTip(), { passive: true });
      window.addEventListener("resize", () => hideTip());
    }

    function initPanel(){
      initTooltips();
      fetchLockState();
      setInterval(fetchLockState, 1500);

      updateWhoAmI();

      const savedBase = localStorage.getItem("worker_base_v1") || "https://panel.sixteysevenharry.workers.dev";
      const savedAdmin = localStorage.getItem("admin_key_v1") || "";
      els.workerBase.value = savedBase;
      els.adminKey.value = savedAdmin;

      (async () => {
        try{
          setStatus("loading","Loading‚Ä¶");
          await refreshAll();
          setStatus("ok","Ready");
        } catch (e){
          setStatus("error","Failed to load");
          toast("err","Load failed", String(e && e.message ? e.message : e));
        }
      })();

      let _logsBusy = false;
      setInterval(async () => {
        try{
          if (_logsBusy) return;
          _logsBusy = true;
          await fetchLogs();
        } catch {} finally {
          _logsBusy = false;
        }
      }, 3000);
    }

    if (isLoggedIn()){
      showApp();
      initPanel();
    } else {
      showLogin();
    }
  </script>
</body>
</html>
