<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Roblox Panel</title>
  <style>
    :root{
      --bg:#f7f7fb;
      --surface:#ffffff;
      --surface2:#fbfbfd;
      --text:#111318;
      --muted:#5c6370;
      --border:#e6e8ee;
      --border2:#d9dde6;
      --ring:#111318;
      --btn:#ffffff;
      --btnText:#111318;
      --btnBorder:#d9dde6;
      --btnHover:#f3f4f7;
      --danger:#b00020;
      --ok:#0b7a3b;

      --radius:16px;
      --radius2:14px;
      --shadow: 0 10px 30px rgba(17,19,24,.08);
      --focus: 0 0 0 4px rgba(17,19,24,.12);
    }

    [data-theme="dark"]{
      --bg:#0c0f14;
      --surface:#121722;
      --surface2:#0f1420;
      --text:#e9edf6;
      --muted:#a9b2c3;
      --border:#202a3a;
      --border2:#2a3750;
      --ring:#e9edf6;
      --btn:#141b29;
      --btnText:#e9edf6;
      --btnBorder:#2a3750;
      --btnHover:#1a2436;
      --danger:#ff4d6d;
      --ok:#3ddc84;

      --shadow: 0 14px 40px rgba(0,0,0,.45);
      --focus: 0 0 0 4px rgba(233,237,246,.16);
    }

    *{box-sizing:border-box}

    body{
      font-family:system-ui,Arial;
      margin:0;
      color:var(--text);
      background:var(--bg);
      transition: background .25s ease, color .25s ease;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:center;
      padding:24px;
    }

    .app{ width:min(1200px, 100%); margin:0 auto; }

    .top{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:16px;
      flex-wrap:wrap;
    }

    h1{
      margin:0;
      font-size:34px;
      letter-spacing:-.5px;
      display:flex;
      align-items:center;
      gap:10px;
    }

    .pillStatus{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background:rgba(255,255,255,.6);
      backdrop-filter: blur(8px);
    }
    [data-theme="dark"] .pillStatus{background:rgba(18,23,34,.6)}

    .dot{ width:8px;height:8px;border-radius:50%; background:var(--muted); }
    .dot.ok{background:var(--ok)}
    .dot.err{background:var(--danger)}
    .dot.load{background:var(--muted); animation:pulse 1.2s ease-in-out infinite}
    @keyframes pulse{0%,100%{opacity:.35}50%{opacity:1}}

    .toolbar{display:flex;align-items:center;gap:10px;flex-wrap:wrap}

    .seg{
      display:flex;
      border:1px solid var(--border);
      border-radius:999px;
      overflow:hidden;
      background:var(--surface);
      box-shadow: var(--shadow);
    }
    .seg button{
      border:0;
      border-right:1px solid var(--border);
      border-radius:0;
      padding:8px 10px;
      background:transparent;
      color:var(--muted);
    }
    .seg button:last-child{border-right:0}
    .seg button[aria-pressed="true"]{
      background:var(--btnHover);
      color:var(--text);
    }

    .grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:24px;
      margin-top:18px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .col{
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:16px;
      background:var(--surface);
      box-shadow: var(--shadow);
      transition: transform .2s ease, box-shadow .2s ease, border-color .2s ease;
    }

    .colTitle{
      font-size:22px;
      margin:0 0 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }

    .countPill{
      font-size:12px;
      opacity:.9;
      padding:4px 8px;
      border:1px solid var(--border);
      border-radius:999px;
      color:var(--muted);
      background:var(--surface2);
    }

    .scroll{
      height:420px;
      overflow:auto;
      border-top:1px solid var(--border);
      padding-top:12px;
      padding-right:6px;
    }

    .card{
      border:1px solid var(--border);
      border-radius:var(--radius2);
      padding:12px 14px;
      margin:10px 0;
      cursor:pointer;
      user-select:none;
      background:linear-gradient(180deg, var(--surface) 0%, var(--surface2) 100%);
      transition: transform .15s ease, border-color .15s ease, background .2s ease;
      transform: translateZ(0);
    }
    .card:hover{border-color:var(--border2);transform:translateY(-1px)}
    .selected{outline:3px solid var(--ring);outline-offset:0;transform:translateY(-1px) scale(1.01)}

    .row{
      display:flex;
      align-items:flex-end;
      gap:10px;
      flex-wrap:wrap;
      margin-top:18px;
    }

    .field{min-width:280px;flex:1 1 280px}

    input{
      width:100%;
      padding:11px 12px;
      border:1px solid var(--border2);
      border-radius:12px;
      background:var(--surface);
      color:var(--text);
      transition: border-color .15s ease, box-shadow .15s ease, background .2s ease;
      outline:none;
    }
    input:focus{box-shadow:var(--focus);border-color:var(--border2)}

    button{
      padding:10px 12px;
      border:1px solid var(--btnBorder);
      border-radius:12px;
      background:var(--btn);
      color:var(--btnText);
      cursor:pointer;
      transition: transform .12s ease, background .15s ease, border-color .15s ease, opacity .15s ease;
      outline:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    button:hover{background:var(--btnHover)}
    button:active{transform:translateY(1px)}
    button:disabled{opacity:.45;cursor:not-allowed;transform:none}

    .btns{display:flex;gap:10px;flex-wrap:wrap}
    .divider{height:1px;background:var(--border);margin:14px 0}

    .meta{
      opacity:.9;
      margin-top:10px;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }

    .small{font-size:12px;opacity:.88;color:var(--muted)}
    .error{color:var(--danger);opacity:1}

    .label{font-size:12px;opacity:.9;margin-bottom:6px;color:var(--muted)}
    .pill{
      display:inline-block;
      padding:3px 8px;
      border:1px solid var(--border);
      border-radius:999px;
      margin-left:8px;
      font-size:12px;
      color:var(--muted);
      background:var(--surface2);
    }

    .staffPill{border-color:var(--border2);opacity:.95}
    .staffCard{opacity:.55;cursor:not-allowed;filter:grayscale(1)}
    .staffCard:hover{border-color:var(--border)}

    .toastWrap{
      position:fixed;
      bottom:18px;
      left:50%;
      transform:translateX(-50%);
      z-index:9999;
      pointer-events:none;
      display:flex;
      flex-direction:column;
      gap:8px;
      width:min(560px, calc(100% - 24px));
    }
    .toast{
      pointer-events:auto;
      border:1px solid var(--border);
      background:rgba(255,255,255,.72);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      border-radius:14px;
      padding:10px 12px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      animation: toastIn .18s ease-out;
    }
    [data-theme="dark"] .toast{background:rgba(18,23,34,.72)}
    @keyframes toastIn{from{transform:translateY(10px);opacity:0}to{transform:translateY(0);opacity:1}}
    .toast .tTitle{font-weight:700}
    .toast .tBody{font-size:12px;color:var(--muted);margin-top:2px}
    .toast .x{border:0;background:transparent;padding:4px 6px;border-radius:10px}
    .toast .x:hover{background:var(--btnHover)}
    .toast.ok{border-color:rgba(11,122,59,.35)}
    .toast.err{border-color:rgba(176,0,32,.35)}
    [data-theme="dark"] .toast.ok{border-color:rgba(61,220,132,.35)}
    [data-theme="dark"] .toast.err{border-color:rgba(255,77,109,.35)}

    .overlay{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
      background: radial-gradient(1200px 700px at 50% 20%, rgba(233,237,246,.08), transparent 55%),
                  rgba(0,0,0,.22);
      backdrop-filter: blur(8px);
      z-index:9998;
    }
    [data-theme="dark"] .overlay{
      background: radial-gradient(1200px 700px at 50% 20%, rgba(233,237,246,.10), transparent 55%),
                  rgba(0,0,0,.55);
    }

    .loginCard{
      width:min(520px, 100%);
      border:1px solid var(--border);
      border-radius:18px;
      background:var(--surface);
      box-shadow: var(--shadow);
      padding:18px;
      animation: toastIn .18s ease-out;
    }

    .modalCard{
      width:min(720px, 100%);
      border:1px solid var(--border);
      border-radius:18px;
      background:var(--surface);
      box-shadow: var(--shadow);
      padding:18px;
      animation: toastIn .18s ease-out;
    }

    .loginTitle{ font-size:22px; margin:0 0 8px; }
    .loginHint{ margin:0 0 14px; color:var(--muted); font-size:13px; }

    .loginRow{ display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap; }
    .loginRow .field{flex:1 1 240px; min-width:240px}
    .loginFoot{
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .ghostBtn{ border:1px solid var(--border); background:transparent; }
    .ghostBtn:hover{background:var(--btnHover)}

    .twoCol{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:14px;
      margin-top:12px;
    }
    @media (max-width: 860px){ .twoCol{grid-template-columns:1fr} }

    .subCard{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      background:linear-gradient(180deg, var(--surface) 0%, var(--surface2) 100%);
    }
    .subTitle{font-weight:800;margin:0 0 6px;font-size:14px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
    .checkRow{display:flex;align-items:center;gap:10px;margin-top:8px;color:var(--muted);font-size:13px}
    .checkRow input{width:auto}
    .hintLine{margin:8px 0 0;color:var(--muted);font-size:12px}
    .log{
      height:140px;
      overflow:auto;
      border-top:1px solid var(--border);
      margin-top:10px;
      padding-top:10px;
      padding-right:6px;
    }
    .logItem{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      margin:8px 0;
      background:var(--surface2);
      font-size:12px;
      color:var(--muted);
    }
    .logItem b{color:var(--text)}
  </style>
</head>

<body>
  <div class="app" id="app" style="display:none">
    <div class="top">
      <h1>
        Players in-game
        <span class="pillStatus" title="Live status">
          <span class="dot" id="statusDot"></span>
          <span class="small" id="status"></span>
        </span>
      </h1>

      <div class="toolbar">
        <button id="helpBtn" type="button" class="ghostBtn" title="How to use">‚ùì Help</button>

        <div class="seg" role="group" aria-label="Theme">
          <button id="themeLight" type="button" aria-pressed="false" title="Light">‚òÄÔ∏è</button>
          <button id="themeDark" type="button" aria-pressed="true" title="Dark">üåô</button>
          <button id="themeAuto" type="button" aria-pressed="false" title="Auto">üñ•Ô∏è</button>
        </div>
        <button id="logout" type="button" class="ghostBtn" title="Log out">üö™ Logout</button>
      </div>
    </div>

    <div class="row">
      <div class="field">
        <div class="label">Players API URL</div>
        <input id="playersApi" placeholder="https://panel.sixteysevenharry.workers.dev/players" />
      </div>
      <div class="field">
        <div class="label">Admin Key</div>
        <input id="adminKey" placeholder="ADMIN_KEY (stored in your browser)" />
      </div>

      <div class="btns" style="margin-top:18px">
        <button id="save" type="button">üíæ Save</button>
        <button id="refresh" type="button">üîÑ Refresh</button>
        <button id="clearModerated" type="button">üßπ Clear Moderated List</button>
      </div>
    </div>

    <div class="twoCol">
      <div class="subCard">
        <div class="subTitle">Options</div>

        <label class="checkRow">
          <input id="optHideStaff" type="checkbox" />
          Hide STAFF users in Active list
        </label>

        <label class="checkRow">
          <input id="optConfirm" type="checkbox" />
          Confirm before Kick / Ban / Unban
        </label>

        <label class="checkRow">
          <input id="optAutoRefresh" type="checkbox" />
          Auto refresh (every 10s)
        </label>

        <div class="hintLine">Tip: refresh is still rate-limited; manual refresh has a 10s cooldown.</div>
      </div>

      <div class="subCard">
        <div class="subTitle">Selected user</div>
        <div class="small" id="selectedInfo">Nothing selected yet.</div>
        <div class="btns" style="margin-top:10px">
          <button id="copyUserId" type="button">üìã Copy UserId</button>
          <button id="openProfile" type="button">üîó Open Profile</button>
          <button id="deselect" type="button" class="ghostBtn">‚úñ Deselect</button>
        </div>
        <div class="hintLine">Select a user from Active or Moderated to enable quick actions.</div>
      </div>
    </div>

    <div class="meta" id="meta">Updated: ? | Total Players: -</div>

    <div class="grid">
      <div class="col">
        <div class="colTitle">
          <span>Active Users</span>
          <span class="countPill" id="activeCount">0</span>
        </div>
        <div class="field" style="margin-top:10px">
          <div class="label">Search Active</div>
          <input id="activeSearch" placeholder="Search by name, @username, userId, team..." />
        </div>
        <div class="scroll" id="activeList"></div>
      </div>

      <div class="col">
        <div class="colTitle">
          <span>Moderated Users</span>
          <span class="countPill" id="moderatedCount">0</span>
        </div>
        <div class="field" style="margin-top:10px">
          <div class="label">Search Moderated</div>
          <input id="modSearch" placeholder="Search moderated list..." />
        </div>
        <div class="scroll" id="moderatedList"></div>
      </div>
    </div>

    <div class="divider"></div>

    <div class="btns">
      <button id="kick" type="button">üë¢ Kick</button>
      <button id="kickReason" type="button">üìù Kick With Reason</button>
      <button id="ban" type="button">‚õî Ban</button>
      <button id="banReason" type="button">üßæ Ban With Reason</button>
      <button id="unban" type="button">‚úÖ Unban</button>
      <button id="unbanReason" type="button">üóíÔ∏è Unban With Reason</button>
    </div>

    <div class="subCard" style="margin-top:18px">
      <div class="subTitle">Action log</div>
      <div class="small">This is just for you (stored in your browser).</div>
      <div class="log" id="actionLog"></div>
      <div class="btns" style="margin-top:10px">
        <button id="clearLog" type="button" class="ghostBtn">üßΩ Clear log</button>
      </div>
    </div>
  </div>

  <div class="overlay" id="loginOverlay" style="display:none">
    <div class="loginCard">
      <h2 class="loginTitle">Panel Login</h2>
      <p class="loginHint">Enter your panel username to continue.</p>

      <div class="loginRow">
        <div class="field">
          <div class="label">Username</div>
          <input id="loginUser" placeholder="e.g. Username" autocomplete="off" />
        </div>
        <button id="loginBtn" type="button">üîì Login</button>
      </div>

      <div class="loginFoot">
        <span class="small" id="loginStatus"></span>
        <span class="small">Tip: usernames are case-insensitive</span>
      </div>
    </div>
  </div>

  <div class="overlay" id="helpOverlay" style="display:none">
    <div class="modalCard">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
        <h2 class="loginTitle" style="margin:0">How to use</h2>
        <button id="closeHelp" type="button" class="ghostBtn">‚úï Close</button>
      </div>

      <div class="twoCol">
        <div class="subCard">
          <div class="subTitle">1) Setup</div>
          <div class="small">
            ‚Ä¢ Paste your <span class="mono">/players</span> URL<br/>
            ‚Ä¢ Paste your <span class="mono">ADMIN_KEY</span><br/>
            ‚Ä¢ Press <b>Save</b>
          </div>
        </div>

        <div class="subCard">
          <div class="subTitle">2) Refresh</div>
          <div class="small">
            Press <b>Refresh</b> to load active players.<br/>
            Refresh has a <b>10 second cooldown</b>.
          </div>
        </div>

        <div class="subCard">
          <div class="subTitle">3) Moderate</div>
          <div class="small">
            Click a user in <b>Active</b> then press Kick/Ban.<br/>
            Moderation buttons have a <b>3 second cooldown</b>.
          </div>
        </div>

        <div class="subCard">
          <div class="subTitle">4) Unban</div>
          <div class="small">
            Click a user in <b>Moderated</b> then press Unban.
          </div>
        </div>

        <div class="subCard" style="grid-column:1/-1">
          <div class="subTitle">Notes</div>
          <div class="small">
            ‚Ä¢ STAFF users can‚Äôt be moderated from this panel.<br/>
            ‚Ä¢ ‚ÄúModerated Users‚Äù list is local (browser) for tracking who you acted on.<br/>
            ‚Ä¢ If you enable Auto refresh, it refreshes every 10 seconds (still rate-limited).
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toastWrap" id="toasts"></div>

  <script>
    const ALLOWED_USERNAMES = new Set([
      "eagla","nebula","specimen","arrow","damage","caprie"
    ]);

    const STAFF_IDS = new Set([
      8007453710,4976035348,154251360,9930928180,485280430
    ]);

    const els = {
      app: document.getElementById("app"),
      loginOverlay: document.getElementById("loginOverlay"),
      loginUser: document.getElementById("loginUser"),
      loginBtn: document.getElementById("loginBtn"),
      loginStatus: document.getElementById("loginStatus"),
      logout: document.getElementById("logout"),

      helpOverlay: document.getElementById("helpOverlay"),
      helpBtn: document.getElementById("helpBtn"),
      closeHelp: document.getElementById("closeHelp"),

      status: document.getElementById("status"),
      statusDot: document.getElementById("statusDot"),
      meta: document.getElementById("meta"),
      playersApi: document.getElementById("playersApi"),
      adminKey: document.getElementById("adminKey"),
      save: document.getElementById("save"),
      refresh: document.getElementById("refresh"),
      activeList: document.getElementById("activeList"),
      moderatedList: document.getElementById("moderatedList"),
      clearModerated: document.getElementById("clearModerated"),
      kick: document.getElementById("kick"),
      kickReason: document.getElementById("kickReason"),
      ban: document.getElementById("ban"),
      banReason: document.getElementById("banReason"),
      unban: document.getElementById("unban"),
      unbanReason: document.getElementById("unbanReason"),
      activeCount: document.getElementById("activeCount"),
      moderatedCount: document.getElementById("moderatedCount"),
      toasts: document.getElementById("toasts"),

      themeLight: document.getElementById("themeLight"),
      themeDark: document.getElementById("themeDark"),
      themeAuto: document.getElementById("themeAuto"),

      optHideStaff: document.getElementById("optHideStaff"),
      optConfirm: document.getElementById("optConfirm"),
      optAutoRefresh: document.getElementById("optAutoRefresh"),

      activeSearch: document.getElementById("activeSearch"),
      modSearch: document.getElementById("modSearch"),

      selectedInfo: document.getElementById("selectedInfo"),
      copyUserId: document.getElementById("copyUserId"),
      openProfile: document.getElementById("openProfile"),
      deselect: document.getElementById("deselect"),

      actionLog: document.getElementById("actionLog"),
      clearLog: document.getElementById("clearLog"),
    };

    const MOD_ENDPOINT = "https://panel.sixteysevenharry.workers.dev/admin/moderate";

    function esc(s){
      return String(s ?? "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    function toast(kind, title, body){
      const div = document.createElement("div");
      div.className = "toast " + (kind || "");
      div.innerHTML = `
        <div>
          <div class="tTitle">${esc(title || "")}</div>
          ${body ? `<div class="tBody">${esc(body)}</div>` : ""}
        </div>
        <button class="x" type="button" aria-label="Close">‚úï</button>
      `;
      div.querySelector(".x").onclick = () => div.remove();
      els.toasts.appendChild(div);
      setTimeout(() => { if (div.isConnected) div.remove(); }, 3200);
    }

    function setStatus(state, text){
      els.status.textContent = text || "";
      els.status.className = "small" + (state === "error" ? " error" : "");
      els.statusDot.className = "dot" + (state === "ok" ? " ok" : state === "error" ? " err" : " load");
    }

    function applyTheme(mode){
      localStorage.setItem("panel_theme_mode", mode);
      els.themeLight.setAttribute("aria-pressed", mode === "light");
      els.themeDark.setAttribute("aria-pressed", mode === "dark");
      els.themeAuto.setAttribute("aria-pressed", mode === "auto");
      if (mode === "auto"){
        document.documentElement.removeAttribute("data-theme");
        return;
      }
      document.documentElement.setAttribute("data-theme", mode);
    }

    const savedTheme = localStorage.getItem("panel_theme_mode") || "dark";
    applyTheme(savedTheme);

    els.themeLight.onclick = () => applyTheme("light");
    els.themeDark.onclick = () => applyTheme("dark");
    els.themeAuto.onclick = () => applyTheme("auto");

    const mq = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)");
    if (mq && mq.addEventListener){
      mq.addEventListener("change", () => {
        const mode = localStorage.getItem("panel_theme_mode") || "dark";
        if (mode === "auto") applyTheme("auto");
      });
    }

    function normalizeUser(s){ return String(s || "").trim().toLowerCase(); }

    function isLoggedIn(){ return localStorage.getItem("panel_logged_in") === "1"; }

    function setLoggedIn(username){
      localStorage.setItem("panel_logged_in", "1");
      localStorage.setItem("panel_login_user", String(username || ""));
    }

    function clearLoggedIn(){
      localStorage.removeItem("panel_logged_in");
      localStorage.removeItem("panel_login_user");
    }

    function showLogin(){
      els.app.style.display = "none";
      els.loginOverlay.style.display = "flex";
      els.helpOverlay.style.display = "none";
      els.loginStatus.textContent = "";
      els.loginUser.value = "";
      els.loginUser.focus();
    }

    function showApp(){
      els.loginOverlay.style.display = "none";
      els.app.style.display = "block";
    }

    function attemptLogin(){
      const u = normalizeUser(els.loginUser.value);
      if (!u){
        els.loginStatus.textContent = "Enter a username.";
        els.loginStatus.className = "small error";
        return;
      }
      if (!ALLOWED_USERNAMES.has(u)){
        els.loginStatus.textContent = "Invalid username.";
        els.loginStatus.className = "small error";
        toast("err", "Login denied", "That username is not allowed");
        return;
      }
      setLoggedIn(u);
      toast("ok", "Logged in", "Welcome");
      showApp();
      initPanel();
    }

    els.loginBtn.onclick = attemptLogin;
    els.loginUser.addEventListener("keydown", (e) => {
      if (e.key === "Enter") attemptLogin();
    });

    els.logout.onclick = () => {
      if (!confirm("Log out?")) return;
      clearLoggedIn();
      toast("ok", "Logged out", "");
      showLogin();
    };

    els.helpBtn.onclick = () => { els.helpOverlay.style.display = "flex"; };
    els.closeHelp.onclick = () => { els.helpOverlay.style.display = "none"; };
    els.helpOverlay.addEventListener("click", (e) => {
      if (e.target === els.helpOverlay) els.helpOverlay.style.display = "none";
    });

    function isStaff(userId){ return STAFF_IDS.has(Number(userId)); }

    function loadModerated(){
      try {
        const raw = localStorage.getItem("moderated_users_v1");
        const list = raw ? JSON.parse(raw) : [];
        return Array.isArray(list) ? list : [];
      } catch { return []; }
    }

    function saveModerated(list){
      localStorage.setItem("moderated_users_v1", JSON.stringify(list));
    }

    function upsertModerated(user, reason){
      const list = loadModerated();
      const idx = list.findIndex(x => Number(x.userId) === Number(user.userId));
      const entry = {
        userId: Number(user.userId),
        username: user.username || "",
        displayName: user.displayName || "",
        team: user.team || null,
        reason: reason || "",
        updatedAt: new Date().toISOString()
      };
      if (idx >= 0) list[idx] = entry;
      else list.unshift(entry);
      saveModerated(list);
    }

    function removeModerated(userId){
      const list = loadModerated().filter(x => Number(x.userId) !== Number(userId));
      saveModerated(list);
    }

    function loadOpts(){
      const v = (k, d) => {
        const raw = localStorage.getItem(k);
        if (raw === null) return d;
        return raw === "1";
      };
      els.optHideStaff.checked = v("opt_hide_staff", true);
      els.optConfirm.checked = v("opt_confirm", true);
      els.optAutoRefresh.checked = v("opt_auto_refresh", false);
    }

    function saveOpts(){
      localStorage.setItem("opt_hide_staff", els.optHideStaff.checked ? "1" : "0");
      localStorage.setItem("opt_confirm", els.optConfirm.checked ? "1" : "0");
      localStorage.setItem("opt_auto_refresh", els.optAutoRefresh.checked ? "1" : "0");
    }

    els.optHideStaff.onchange = () => { saveOpts(); renderActive(); };
    els.optConfirm.onchange = () => { saveOpts(); };
    els.optAutoRefresh.onchange = () => { saveOpts(); setupAutoRefresh(); };

    function loadLog(){
      try{
        const raw = localStorage.getItem("panel_action_log_v1");
        const list = raw ? JSON.parse(raw) : [];
        return Array.isArray(list) ? list : [];
      } catch { return []; }
    }
    function saveLog(list){
      localStorage.setItem("panel_action_log_v1", JSON.stringify(list.slice(0, 60)));
    }
    function addLog(text){
      const list = loadLog();
      list.unshift({ t: new Date().toISOString(), text: String(text || "") });
      saveLog(list);
      renderLog();
    }
    function renderLog(){
      const list = loadLog();
      els.actionLog.innerHTML = "";
      if (!list.length){
        els.actionLog.innerHTML = "<div class='small'>No actions yet.</div>";
        return;
      }
      for (const it of list){
        const div = document.createElement("div");
        div.className = "logItem";
        div.innerHTML = `<div><b>${esc(it.text)}</b></div><div>${esc(it.t)}</div>`;
        els.actionLog.appendChild(div);
      }
    }
    els.clearLog.onclick = () => {
      localStorage.removeItem("panel_action_log_v1");
      renderLog();
      toast("ok", "Cleared", "Action log cleared");
    };

    let activePlayers = [];
    let selectedActiveUserId = null;
    let selectedModeratedUserId = null;

    let refreshCooldownUntil = 0;
    let refreshCooldownTimer = null;

    function startRefreshCooldown(seconds){
      refreshCooldownUntil = Date.now() + (seconds * 1000);
      els.refresh.disabled = true;

      const tick = () => {
        const left = Math.max(0, Math.ceil((refreshCooldownUntil - Date.now()) / 1000));
        if (left > 0) {
          els.refresh.textContent = `‚è≥ Refresh (${left}s)`;
          refreshCooldownTimer = setTimeout(tick, 250);
        } else {
          els.refresh.textContent = "üîÑ Refresh";
          els.refresh.disabled = false;
          if (refreshCooldownTimer) clearTimeout(refreshCooldownTimer);
          refreshCooldownTimer = null;
        }
      };
      tick();
    }

    const __btnOriginalText = new WeakMap();
    function startButtonCooldown(btn, seconds){
      if (!btn || btn.disabled) return false;
      const original = btn.textContent;
      __btnOriginalText.set(btn, original);
      btn.disabled = true;
      const until = Date.now() + (seconds * 1000);

      const tick = () => {
        const left = Math.max(0, Math.ceil((until - Date.now()) / 1000));
        if (left > 0) {
          btn.textContent = `‚è≥ (${left}s)`;
          setTimeout(tick, 250);
        } else {
          btn.textContent = __btnOriginalText.get(btn) || original;
          btn.disabled = false;
          __btnOriginalText.delete(btn);
          updateButtons();
        }
      };
      tick();
      return true;
    }

    function getSearchText(p){
      return (
        String(p.displayName || "") + " " +
        String(p.username || "") + " " +
        String(p.team || "") + " " +
        String(p.userId || "")
      ).toLowerCase();
    }

    function setSelectedInfo(){
      const sel = getSelectedActive() || getSelectedModerated();
      if (!sel){
        els.selectedInfo.textContent = "Nothing selected yet.";
        els.copyUserId.disabled = true;
        els.openProfile.disabled = true;
        els.deselect.disabled = true;
        return;
      }
      const name = sel.displayName || sel.username || "Unknown";
      const uid = Number(sel.userId) || 0;
      const team = sel.team ? ` | Team: ${sel.team}` : "";
      els.selectedInfo.textContent = `${name} (@${sel.username || ""}) | UserId: ${uid}${team}`;
      els.copyUserId.disabled = !uid;
      els.openProfile.disabled = !uid;
      els.deselect.disabled = false;
    }

    function deselectAll(){
      selectedActiveUserId = null;
      selectedModeratedUserId = null;
      renderActive();
      renderModerated();
      updateButtons();
      setSelectedInfo();
    }

    els.deselect.onclick = () => { if (!startButtonCooldown(els.deselect, 3)) return; deselectAll(); };

    els.copyUserId.onclick = async () => {
      const sel = getSelectedActive() || getSelectedModerated();
      if (!sel) return;
      if (!startButtonCooldown(els.copyUserId, 3)) return;
      const uid = String(Number(sel.userId) || "");
      try{
        await navigator.clipboard.writeText(uid);
        toast("ok", "Copied", "UserId copied to clipboard");
      } catch {
        toast("err", "Copy failed", "Your browser blocked clipboard access");
      }
    };

    els.openProfile.onclick = () => {
      const sel = getSelectedActive() || getSelectedModerated();
      if (!sel) return;
      if (!startButtonCooldown(els.openProfile, 3)) return;
      const uid = Number(sel.userId) || 0;
      if (!uid) return;
      window.open(`https://www.roblox.com/users/${uid}/profile`, "_blank", "noopener,noreferrer");
    };

    function setSelectedActive(userId){
      selectedActiveUserId = Number(userId);
      selectedModeratedUserId = null;
      renderActive();
      renderModerated();
      updateButtons();
      setSelectedInfo();
    }

    function setSelectedModerated(userId){
      selectedModeratedUserId = Number(userId);
      selectedActiveUserId = null;
      renderActive();
      renderModerated();
      updateButtons();
      setSelectedInfo();
    }

    function makeCardHTML(p){
      const name = esc(p.displayName || p.username);
      const handle = esc(p.username || "");
      const team = p.team ? `<span class="pill">${esc(p.team)}</span>` : "";
      const staff = isStaff(p.userId) ? `<span class="pill staffPill">STAFF</span>` : "";
      return `
        <div><b>${name}</b> <span class="small">(@${handle})</span> ${team} ${staff}</div>
        <div class="small">UserId: ${Number(p.userId) || ""}</div>
      `;
    }

    function setCounts(){
      const modCount = loadModerated().length || 0;
      els.moderatedCount.textContent = String(modCount);

      const hideStaff = !!els.optHideStaff.checked;
      const q = (els.activeSearch.value || "").trim().toLowerCase();
      const filtered = activePlayers.filter(p => {
        if (hideStaff && isStaff(p.userId)) return false;
        if (!q) return true;
        return getSearchText(p).includes(q);
      });
      els.activeCount.textContent = String(filtered.length || 0);
    }

    function renderActive(){
      els.activeList.innerHTML = "";
      setCounts();

      const hideStaff = !!els.optHideStaff.checked;
      const q = (els.activeSearch.value || "").trim().toLowerCase();

      const list = activePlayers.filter(p => {
        if (hideStaff && isStaff(p.userId)) return false;
        if (!q) return true;
        return getSearchText(p).includes(q);
      });

      if (!list.length) {
        els.activeList.innerHTML = "<div class='small'>No matching active users.</div>";
        return;
      }

      for (const p of list){
        const staff = isStaff(p.userId);
        const div = document.createElement("div");
        div.className =
          "card" +
          (Number(p.userId) === Number(selectedActiveUserId) ? " selected" : "") +
          (staff ? " staffCard" : "");

        div.innerHTML = makeCardHTML(p);

        if (!staff) div.onclick = () => setSelectedActive(p.userId);

        els.activeList.appendChild(div);
      }
    }

    function renderModerated(){
      els.moderatedList.innerHTML = "";
      setCounts();

      const q = (els.modSearch.value || "").trim().toLowerCase();
      const list = loadModerated().filter(p => {
        if (!q) return true;
        return getSearchText(p).includes(q);
      });

      if (!list.length) {
        els.moderatedList.innerHTML = "<div class='small'>No matching moderated users.</div>";
        return;
      }

      for (const p of list){
        const staff = isStaff(p.userId);
        const div = document.createElement("div");
        div.className =
          "card" +
          (Number(p.userId) === Number(selectedModeratedUserId) ? " selected" : "") +
          (staff ? " staffCard" : "");

        div.innerHTML =
          makeCardHTML(p) +
          (p.reason ? `<div class="small">Reason: ${esc(p.reason)}</div>` : "");

        if (!staff) div.onclick = () => setSelectedModerated(p.userId);

        els.moderatedList.appendChild(div);
      }
    }

    els.activeSearch.addEventListener("input", () => renderActive());
    els.modSearch.addEventListener("input", () => renderModerated());

    function updateButtons(){
      const hasActive = Number.isFinite(selectedActiveUserId) && selectedActiveUserId !== null;
      const hasMod = Number.isFinite(selectedModeratedUserId) && selectedModeratedUserId !== null;

      const activeIsStaff = hasActive && isStaff(selectedActiveUserId);

      const cooling = (b) => b && __btnOriginalText.has(b);

      els.kick.disabled = !hasActive || activeIsStaff || cooling(els.kick);
      els.kickReason.disabled = !hasActive || activeIsStaff || cooling(els.kickReason);
      els.ban.disabled = !hasActive || activeIsStaff || cooling(els.ban);
      els.banReason.disabled = !hasActive || activeIsStaff || cooling(els.banReason);

      els.unban.disabled = !hasMod || cooling(els.unban);
      els.unbanReason.disabled = !hasMod || cooling(els.unbanReason);

      if (refreshCooldownTimer) els.refresh.disabled = true;
    }

    async function fetchPlayers(){
      const url = els.playersApi.value.trim();
      if (!url) {
        setStatus("error", "Paste your /players URL.");
        return;
      }

      setStatus("loading", "Loading...");

      try{
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        els.meta.textContent =
          `Updated: ${data.updatedAt || "?"} | Total Players: ${data.totalPlayers ?? (data.players ? data.players.length : 0)}`;

        activePlayers = Array.isArray(data.players) ? data.players : [];
        activePlayers.sort((a,b) => String(a.displayName || a.username).localeCompare(String(b.displayName || b.username)));

        if (selectedActiveUserId && !activePlayers.some(p => Number(p.userId) === Number(selectedActiveUserId))) {
          selectedActiveUserId = null;
        }

        setStatus("ok", "OK");
        renderActive();
        renderModerated();
        updateButtons();
        setSelectedInfo();
      } catch(e){
        setStatus("error", "Failed: " + e.message);
        toast("err", "Refresh failed", e.message);
      }
    }

    async function sendModeration(action, userId, reason){
      if (isStaff(userId)) {
        alert("That user is marked as STAFF and cannot be moderated from this panel.");
        return { ok: false };
      }

      const adminKey = els.adminKey.value.trim();
      if (!adminKey) {
        alert("Enter ADMIN_KEY first.");
        return { ok: false };
      }

      const payload = { action, userId };
      if (reason) payload.reason = reason;

      const res = await fetch(MOD_ENDPOINT, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-admin-key": adminKey
        },
        body: JSON.stringify(payload)
      });

      let body = null;
      try { body = await res.json(); } catch {}

      if (!res.ok) {
        alert((body && body.error) ? body.error : ("Request failed: HTTP " + res.status));
        return { ok: false };
      }

      return { ok: true };
    }

    function getSelectedActive(){
      return activePlayers.find(p => Number(p.userId) === Number(selectedActiveUserId)) || null;
    }

    function getSelectedModerated(){
      return loadModerated().find(p => Number(p.userId) === Number(selectedModeratedUserId)) || null;
    }

    function confirmIfNeeded(text){
      if (!els.optConfirm.checked) return true;
      return confirm(text);
    }

    els.kick.onclick = async () => {
      const p = getSelectedActive();
      if (!p) return;
      if (!confirmIfNeeded(`Kick ${p.displayName || p.username} (${p.userId})?`)) return;
      if (!startButtonCooldown(els.kick, 3)) return;
      const ok = await sendModeration("kick", p.userId, "");
      if (ok.ok){
        toast("ok", "Kick sent", `${p.displayName || p.username} (${p.userId})`);
        addLog(`Kick: ${p.displayName || p.username} (${p.userId})`);
      }
    };

    els.kickReason.onclick = async () => {
      const p = getSelectedActive();
      if (!p) return;
      const r = prompt("Kick reason?") || "";
      if (!confirmIfNeeded(`Kick ${p.displayName || p.username} (${p.userId})${r ? ` with reason: ${r}` : ""}?`)) return;
      if (!startButtonCooldown(els.kickReason, 3)) return;
      const ok = await sendModeration("kick", p.userId, r);
      if (ok.ok){
        toast("ok", "Kick sent", r ? `Reason: ${r}` : `${p.displayName || p.username} (${p.userId})`);
        addLog(`Kick: ${p.displayName || p.username} (${p.userId})${r ? ` | ${r}` : ""}`);
      }
    };

    els.ban.onclick = async () => {
      const p = getSelectedActive();
      if (!p) return;
      if (!confirmIfNeeded(`Ban ${p.displayName || p.username} (${p.userId})?`)) return;
      if (!startButtonCooldown(els.ban, 3)) return;
      const ok = await sendModeration("ban", p.userId, "");
      if (ok.ok){
        upsertModerated(p, "");
        toast("ok", "Ban sent", `${p.displayName || p.username} (${p.userId})`);
        addLog(`Ban: ${p.displayName || p.username} (${p.userId})`);
        renderModerated();
      }
    };

    els.banReason.onclick = async () => {
      const p = getSelectedActive();
      if (!p) return;
      const r = prompt("Ban reason?") || "";
      if (!confirmIfNeeded(`Ban ${p.displayName || p.username} (${p.userId})${r ? ` with reason: ${r}` : ""}?`)) return;
      if (!startButtonCooldown(els.banReason, 3)) return;
      const ok = await sendModeration("ban", p.userId, r);
      if (ok.ok){
        upsertModerated(p, r);
        toast("ok", "Ban sent", r ? `Reason: ${r}` : `${p.displayName || p.username} (${p.userId})`);
        addLog(`Ban: ${p.displayName || p.username} (${p.userId})${r ? ` | ${r}` : ""}`);
        renderModerated();
      }
    };

    els.unban.onclick = async () => {
      const p = getSelectedModerated();
      if (!p) return;
      if (!confirmIfNeeded(`Unban ${p.displayName || p.username} (${p.userId})?`)) return;
      if (!startButtonCooldown(els.unban, 3)) return;
      const ok = await sendModeration("unban", p.userId, "");
      if (ok.ok){
        removeModerated(p.userId);
        selectedModeratedUserId = null;
        toast("ok", "Unban sent", `${p.displayName || p.username} (${p.userId})`);
        addLog(`Unban: ${p.displayName || p.username} (${p.userId})`);
        renderModerated();
        updateButtons();
        setSelectedInfo();
      }
    };

    els.unbanReason.onclick = async () => {
      const p = getSelectedModerated();
      if (!p) return;
      const r = prompt("Unban note?") || "";
      if (!confirmIfNeeded(`Unban ${p.displayName || p.username} (${p.userId})${r ? ` (note: ${r})` : ""}?`)) return;
      if (!startButtonCooldown(els.unbanReason, 3)) return;
      const ok = await sendModeration("unban", p.userId, r);
      if (ok.ok){
        removeModerated(p.userId);
        selectedModeratedUserId = null;
        toast("ok", "Unban sent", r ? `Note: ${r}` : `${p.displayName || p.username} (${p.userId})`);
        addLog(`Unban: ${p.displayName || p.username} (${p.userId})${r ? ` | ${r}` : ""}`);
        renderModerated();
        updateButtons();
        setSelectedInfo();
      }
    };

    els.save.onclick = () => {
      if (!startButtonCooldown(els.save, 3)) return;
      localStorage.setItem("players_api_url", els.playersApi.value.trim());
      localStorage.setItem("admin_key_v1", els.adminKey.value.trim());
      setStatus("ok", "Saved");
      toast("ok", "Saved", "API URL + Admin Key stored in this browser");
      addLog("Saved settings");
    };

    els.refresh.onclick = async () => {
      if (els.refresh.disabled) return;
      startRefreshCooldown(10);
      await fetchPlayers();
      addLog("Refreshed players list");
    };

    els.clearModerated.onclick = () => {
      if (!confirm("Clear moderated list (local only)?")) return;
      if (!startButtonCooldown(els.clearModerated, 3)) return;
      saveModerated([]);
      selectedModeratedUserId = null;
      renderModerated();
      updateButtons();
      setSelectedInfo();
      toast("ok", "Cleared", "Moderated list cleared (local)");
      addLog("Cleared moderated list");
    };

    let autoTimer = null;
    function setupAutoRefresh(){
      if (autoTimer){ clearInterval(autoTimer); autoTimer = null; }
      if (!els.optAutoRefresh.checked) return;
      autoTimer = setInterval(() => {
        if (els.refresh.disabled) return;
        startRefreshCooldown(10);
        fetchPlayers();
      }, 10000);
    }

    function initPanel(){
      const savedApi = localStorage.getItem("players_api_url");
      const savedAdmin = localStorage.getItem("admin_key_v1");
      if (savedApi) els.playersApi.value = savedApi;
      else els.playersApi.value = "https://panel.sixteysevenharry.workers.dev/players";
      if (savedAdmin) els.adminKey.value = savedAdmin;

      loadOpts();
      renderActive();
      renderModerated();
      renderLog();
      updateButtons();
      setSelectedInfo();

      setStatus("ok", "Ready (press Refresh)");
      setupAutoRefresh();
    }

    if (isLoggedIn()){
      showApp();
      initPanel();
    } else {
      showLogin();
    }
  </script>
</body>
</html>
